<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard V2 - LienDeadline.com</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KYZG0TN07Z"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KYZG0TN07Z');
    </script>
    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="02250d35-ee17-41be-845d-2fe0f7f15e63"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer data-domain="liendeadline.com" src="https://plausible.io/js/script.js"></script>
    
    <!-- Admin API Key (injected server-side) -->
    <script>
        // Admin API key for accessing /api/admin/* endpoints
        // This is injected by the server and should match ADMIN_API_KEY env var
        window.ADMIN_API_KEY = "{{ADMIN_API_KEY}}";
    </script>
    
    <!-- V2 Scoped Styles -->
    <style>
      #admin-v2 {
        font-family: "Inter", system-ui, sans-serif;
        -webkit-font-smoothing: antialiased;
        --navy: #1e3a8a;
        --coral: #f97316;
        --background: #faf9f6;
        --foreground: #1f2937;
        --card: #ffffff;
        --border: #e5e7eb;
        --muted: #6b7280;
        --muted-bg: #f3f4f6;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #dc2626;
        --primary: #1e3a8a;
      }
      
      #admin-v2 {
        background: var(--background);
        color: var(--foreground);
        min-height: 100vh;
      }
      
      #admin-v2 .dashboard-card {
        background: var(--card);
        border-radius: 0.5rem;
        border: 1px solid var(--border);
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      }
      
      #admin-v2 .kpi-card {
        background: var(--card);
        border-radius: 0.5rem;
        border: 1px solid var(--border);
        padding: 1.25rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      }
      
      #admin-v2 .admin-table {
        width: 100%;
        border-collapse: collapse;
      }
      
      #admin-v2 .admin-table thead {
        background: var(--muted-bg);
      }
      
      #admin-v2 .admin-table th {
        padding: 0.75rem 1rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--muted);
        border-bottom: 1px solid var(--border);
      }
      
      #admin-v2 .admin-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid var(--border);
      }
      
      #admin-v2 .admin-table tbody tr:hover {
        background: var(--muted-bg);
      }
      
      #admin-v2 .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
      }
      
      #admin-v2 .badge-pending {
        background: #fef3c7;
        color: #92400e;
      }
      
      #admin-v2 .badge-ready {
        background: #d1fae5;
        color: #065f46;
      }
      
      #admin-v2 .badge-paid {
        background: #dbeafe;
        color: #1e40af;
      }
      
      #admin-v2 .badge-overdue {
        background: #fee2e2;
        color: #991b1b;
      }
      
      #admin-v2 .badge-success {
        background: #d1fae5;
        color: #065f46;
      }
      
      #admin-v2 .badge-error {
        background: #fee2e2;
        color: #991b1b;
      }
      
      #admin-v2 .badge-monthly {
        background: #f3e8ff;
        color: #6b21a8;
      }
      
      #admin-v2 .badge-bounty {
        background: #fed7aa;
        color: #9a3412;
      }
      
      #admin-v2 .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.875rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      #admin-v2 .btn-primary {
        background: var(--primary);
        color: white;
      }
      
      #admin-v2 .btn-primary:hover {
        background: #1e40af;
      }
      
      #admin-v2 .btn-success {
        background: var(--success);
        color: white;
      }
      
      #admin-v2 .btn-success:hover {
        background: #059669;
      }
      
      #admin-v2 .btn-danger {
        background: var(--error);
        color: white;
      }
      
      #admin-v2 .btn-danger:hover {
        background: #b91c1c;
      }
      
      #admin-v2 .btn-outline {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--foreground);
      }
      
      #admin-v2 .btn-outline:hover {
        background: var(--muted-bg);
      }
      
      #admin-v2 .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
      }
      
      #admin-v2 .tab-button {
        padding: 0.75rem 1.5rem;
        border: none;
        background: transparent;
        color: var(--muted);
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
      }
      
      #admin-v2 .tab-button:hover {
        color: var(--foreground);
      }
      
      #admin-v2 .tab-button.active {
        color: var(--coral);
        border-bottom-color: var(--coral);
      }
      
      #admin-v2 .tab-content {
        display: none;
      }
      
      #admin-v2 .tab-content.active {
        display: block;
      }
      
      #admin-v2 h1, #admin-v2 h2, #admin-v2 h3 {
        font-family: 'Instrument Serif', serif;
      }
    </style>
</head>
<body>
    <div id="admin-v2">
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-white border-b border-gray-200">
            <div class="max-w-[1600px] mx-auto px-6 py-4 flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-semibold" style="color: var(--foreground);">LienDeadline Admin</h1>
                    <p class="text-sm" style="color: var(--muted);">Dashboard for managing users and customers</p>
                </div>
                <div class="flex items-center gap-3">
                    <a href="/" class="btn btn-outline btn-sm" target="_blank">View Site</a>
                    <a href="/admin-dashboard?ui=v1" class="btn btn-outline btn-sm">Switch to V1</a>
                    <button onclick="logout()" class="btn btn-outline btn-sm" style="color: var(--muted);">Logout</button>
                </div>
            </div>
        </header>
        
        <main class="max-w-[1600px] mx-auto px-6 py-6 space-y-6">
            <!-- KPI Cards -->
            <section class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="kpi-card">
                    <div class="flex items-start justify-between">
                        <div class="space-y-1">
                            <p class="text-sm font-medium" style="color: var(--muted);">Today's Revenue</p>
                            <p class="text-2xl font-semibold tracking-tight" id="v2-todayRevenue">$0</p>
                        </div>
                        <div class="flex items-center justify-center w-10 h-10 rounded-lg" style="background: rgba(30, 58, 138, 0.1);">
                            <span style="color: var(--primary);">üí∞</span>
                        </div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="flex items-start justify-between">
                        <div class="space-y-1">
                            <p class="text-sm font-medium" style="color: var(--muted);">Active Customers</p>
                            <p class="text-2xl font-semibold tracking-tight" id="v2-activeCustomers">0</p>
                        </div>
                        <div class="flex items-center justify-center w-10 h-10 rounded-lg" style="background: rgba(16, 185, 129, 0.1);">
                            <span style="color: var(--success);">üë•</span>
                        </div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="flex items-start justify-between">
                        <div class="space-y-1">
                            <p class="text-sm font-medium" style="color: var(--muted);">Calculations Today</p>
                            <p class="text-2xl font-semibold tracking-tight" id="v2-calculationsToday">0</p>
                        </div>
                        <div class="flex items-center justify-center w-10 h-10 rounded-lg" style="background: rgba(245, 158, 11, 0.1);">
                            <span style="color: var(--warning);">üìä</span>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Comprehensive Analytics -->
            <section>
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <span style="color: var(--primary);">üìä</span>
                    Comprehensive Analytics
                </h2>
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="dashboard-card p-6">
                        <h3 class="text-lg font-semibold mb-4">üìä Calculations</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span style="color: var(--muted);">Today:</span>
                                <span class="font-semibold" id="v2-calc-today">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: var(--muted);">This Week:</span>
                                <span class="font-semibold" id="v2-calc-week">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: var(--muted);">This Month:</span>
                                <span class="font-semibold" id="v2-calc-month">0</span>
                            </div>
                            <div class="flex justify-between border-t pt-2 mt-2">
                                <span class="font-medium">All Time:</span>
                                <span class="font-bold" style="color: var(--primary);" id="v2-calc-all">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-card p-6">
                        <h3 class="text-lg font-semibold mb-4">üí∞ Revenue</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span style="color: var(--muted);">Today:</span>
                                <span class="font-semibold" id="v2-rev-today">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: var(--muted);">This Week:</span>
                                <span class="font-semibold" id="v2-rev-week">$0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: var(--muted);">This Month:</span>
                                <span class="font-semibold" id="v2-rev-month">$0.00</span>
                            </div>
                            <div class="flex justify-between border-t pt-2 mt-2">
                                <span class="font-medium">All Time:</span>
                                <span class="font-bold" style="color: var(--success);" id="v2-rev-all">$0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-card p-6">
                        <h3 class="text-lg font-semibold mb-4">üìß Email Captures</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span style="color: var(--muted);">Today:</span>
                                <span class="font-semibold" id="v2-email-today">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: var(--muted);">This Week:</span>
                                <span class="font-semibold" id="v2-email-week">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span style="color: var(--muted);">This Month:</span>
                                <span class="font-semibold" id="v2-email-month">0</span>
                            </div>
                            <div class="flex justify-between border-t pt-2 mt-2">
                                <span class="font-medium">All Time:</span>
                                <span class="font-bold" style="color: #9333ea;" id="v2-email-all">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Registered Users Section -->
            <section>
                <div class="dashboard-card overflow-hidden">
                    <div class="flex items-center justify-between p-5 border-b border-gray-200">
                        <h2 class="text-lg font-semibold">Registered Users</h2>
                        <span class="badge badge-ready" id="v2-activeCustomers">0 Users</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Name</th>
                                    <th>Company</th>
                                    <th>Subscription</th>
                                    <th>Joined</th>
                                    <th>Last Login</th>
                                </tr>
                            </thead>
                            <tbody id="v2-usersList">
                                <tr>
                                    <td colspan="6" class="text-center py-8" style="color: var(--muted);">
                                        Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- System Panel -->
            <section class="grid lg:grid-cols-3 gap-6">
                <div class="lg:col-span-3">
                <div>
                    <div class="dashboard-card p-6">
                        <h3 class="font-medium mb-4">System Health</h3>
                        <div class="space-y-2 mb-6">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                <span>API: Online</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                <span>Database: Healthy</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                <span>Email: Connected</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                <span>Stripe: Active</span>
                            </div>
                        </div>
                        <h3 class="font-medium mb-3">Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="generateTestKey()" class="btn btn-outline btn-sm">Test Key</button>
                            <button onclick="runBackup()" class="btn btn-outline btn-sm">Backup</button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- User Management Section -->
            <section>
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                    <div>
                        <h2 class="text-xl font-semibold flex items-center gap-2">
                            <span style="color: var(--primary);">üë§</span>
                            User Management
                        </h2>
                        <p class="text-sm" style="color: var(--muted);">Update user emails and reset passwords</p>
                    </div>
                </div>
                
                <div class="dashboard-card p-6">
                    <h3 class="text-lg font-semibold mb-4">Create or Update User Account</h3>
                    <p class="text-sm mb-4" style="color: var(--muted);">
                        <strong>To create a new user:</strong> Leave "Current Email" empty and enter the new email and password.<br>
                        <strong>To update existing user:</strong> Enter the current email, new email, and new password.
                    </p>
                    <form id="update-user-form" class="space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label for="old-email" class="block text-sm font-medium mb-2" style="color: var(--foreground);">
                                    Current Email <span class="text-xs" style="color: var(--muted);">(leave empty to create new user)</span>
                                </label>
                                <input 
                                    type="email" 
                                    id="old-email" 
                                    name="old_email"
                                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                    placeholder="admin@example.com (optional)"
                                    style="border-color: var(--border);"
                                >
                            </div>
                            <div>
                                <label for="new-email" class="block text-sm font-medium mb-2" style="color: var(--foreground);">
                                    New Email *
                                </label>
                                <input 
                                    type="email" 
                                    id="new-email" 
                                    name="new_email"
                                    required
                                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                    placeholder="kartaginy1@gmail.com"
                                    style="border-color: var(--border);"
                                >
                            </div>
                        </div>
                        <div>
                            <label for="new-password" class="block text-sm font-medium mb-2" style="color: var(--foreground);">
                                New Password *
                            </label>
                            <input 
                                type="text" 
                                id="new-password" 
                                name="new_password"
                                required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                placeholder="TestPassword123!"
                                value="TestPassword123!"
                                style="border-color: var(--border);"
                            >
                            <p class="text-xs mt-1" style="color: var(--muted);">
                                Default password: TestPassword123! (you can change it)
                            </p>
                        </div>
                        
                        <!-- Success Message -->
                        <div id="update-user-success" class="hidden p-4 rounded-lg" style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success);">
                            <div class="flex items-start gap-2">
                                <span style="color: var(--success);">‚úÖ</span>
                                <div class="flex-1">
                                    <p class="font-medium" style="color: var(--success);">User updated successfully!</p>
                                    <div id="update-user-details" class="mt-2 text-sm" style="color: var(--muted);"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error Message -->
                        <div id="update-user-error" class="hidden p-4 rounded-lg" style="background: rgba(220, 38, 38, 0.1); border: 1px solid var(--error);">
                            <div class="flex items-start gap-2">
                                <span style="color: var(--error);">‚ùå</span>
                                <div class="flex-1">
                                    <p class="font-medium" style="color: var(--error);">Update failed</p>
                                    <p id="update-user-error-text" class="mt-1 text-sm" style="color: var(--error);"></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button 
                                type="submit" 
                                id="update-user-button"
                                class="btn btn-primary"
                            >
                                Update User
                            </button>
                            <button 
                                type="button" 
                                onclick="resetUpdateUserForm()"
                                class="btn btn-outline"
                            >
                                Reset Form
                            </button>
                        </div>
                    </form>
                </div>
            </section>
            
                                    <th>Last Payment</th>
                                    <th>Total Paid</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="v2-brokersList">
                                <!-- Dynamic rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- Live Analytics Bar -->
            <section>
                <div class="dashboard-card p-5">
                    <h3 class="text-lg font-semibold mb-4">Live Analytics</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold" id="v2-pvToday">‚Äî</div>
                            <div class="text-sm" style="color: var(--muted);">Page Views Today</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold" id="v2-uvToday">‚Äî</div>
                            <div class="text-sm" style="color: var(--muted);">Unique Visitors Today</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold" id="v2-calcToday">‚Äî</div>
                            <div class="text-sm" style="color: var(--muted);">Calculations Today</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold" id="v2-paidToday">‚Äî</div>
                            <div class="text-sm" style="color: var(--muted);">Paid All Time</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- API Keys & Customers Section -->
            <section>
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                    <div>
                        <h2 class="text-xl font-semibold flex items-center gap-2">
                            <span style="color: var(--primary);">üîë</span>
                            API Keys & Customers
                        </h2>
                        <p class="text-sm" style="color: var(--muted);">Manage customer API keys, usage, and access</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="loadApiUsageStats()" class="btn btn-outline btn-sm">
                            üìä Usage Stats
                        </button>
                        <button onclick="loadCustomers()" class="btn btn-outline btn-sm">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                
                <!-- API Usage Analytics -->
                <div class="dashboard-card p-5 mb-6">
                    <h3 class="text-lg font-semibold mb-4">API Usage Analytics</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <div class="text-sm" style="color: var(--muted);">Today</div>
                            <div class="text-2xl font-bold" id="api-calls-today">0</div>
                        </div>
                        <div>
                            <div class="text-sm" style="color: var(--muted);">This Week</div>
                            <div class="text-2xl font-bold" id="api-calls-week">0</div>
                        </div>
                        <div>
                            <div class="text-sm" style="color: var(--muted);">This Month</div>
                            <div class="text-2xl font-bold" id="api-calls-month">0</div>
                        </div>
                        <div>
                            <div class="text-sm" style="color: var(--muted);">Error Rate</div>
                            <div class="text-2xl font-bold" id="api-error-rate">0%</div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="text-sm font-semibold mb-2">Most Used States</div>
                        <div id="api-most-used-states" class="flex flex-wrap gap-2">
                            <!-- Dynamic badges -->
                        </div>
                    </div>
                </div>
                
                <!-- Customers Table -->
                <div class="dashboard-card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Plan</th>
                                    <th>API Key</th>
                                    <th>API Calls (30d)</th>
                                    <th>Last Used</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="api-customers-list">
                                <tr>
                                    <td colspan="8" class="text-center py-8" style="color: var(--muted);">
                                        Loading customers...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Modals (reuse existing modal IDs for compatibility) -->
    <div id="paymentInfoModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Broker Payment Information</h2>
                <button onclick="closeModal('paymentInfoModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="payment-info-content" class="space-y-4">
                <!-- Content loaded dynamically -->
            </div>
            <div class="mt-6 flex gap-4">
                <button onclick="closeModal('paymentInfoModal')" class="btn btn-outline flex-1">Close</button>
            </div>
        </div>
    </div>
    
    <div id="markPaidModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-4">Mark Payment as Paid</h2>
            <form id="mark-paid-form" onsubmit="handleMarkPaid(event)" class="space-y-4">
                <input type="hidden" id="paid-broker-id">
                <div>
                    <label class="block text-sm font-medium mb-2">Payment Method Used *</label>
                    <select id="paid-method" required class="w-full px-4 py-2 border border-gray-300 rounded-md">
                        <option value="">Select payment method</option>
                        <option value="paypal">PayPal</option>
                        <option value="wise">Wise (TransferWise)</option>
                        <option value="revolut">Revolut</option>
                        <option value="sepa">SEPA Transfer</option>
                        <option value="swift">SWIFT/Wire Transfer</option>
                        <option value="crypto">Cryptocurrency</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Transaction ID / Reference Number *</label>
                    <input type="text" id="paid-transaction-id" required placeholder="WS-12345678" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Amount Paid *</label>
                    <input type="number" id="paid-amount" required step="0.01" min="0" placeholder="100.00" class="w-full px-4 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Notes (Optional)</label>
                    <textarea id="paid-notes" rows="3" placeholder="Paid via Wise batch" class="w-full px-4 py-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="paid-confirm" required class="mr-2">
                        <span class="text-sm">I confirm payment was sent</span>
                    </label>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="btn btn-success flex-1">Mark as Paid</button>
                    <button type="button" onclick="closeModal('markPaidModal')" class="btn btn-outline flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Broker Ledger Breakdown Modal -->
    <div id="ledgerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Broker Payout Ledger</h2>
                <button onclick="closeModal('ledgerModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Broker Info -->
            <div class="mb-6 p-4 rounded-lg" style="background: var(--muted-bg);">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <div class="text-sm" style="color: var(--muted);">Broker Name</div>
                        <div class="font-semibold" id="ledger-broker-name">‚Äî</div>
                    </div>
                    <div>
                        <div class="text-sm" style="color: var(--muted);">Email</div>
                        <div class="font-semibold" id="ledger-broker-email">‚Äî</div>
                    </div>
                    <div>
                        <div class="text-sm" style="color: var(--muted);">Commission Model</div>
                        <div class="font-semibold" id="ledger-commission-model">‚Äî</div>
                    </div>
                    <div>
                        <div class="text-sm" style="color: var(--muted);">Next Payout Date</div>
                        <div class="font-semibold" id="ledger-next-payout">‚Äî</div>
                    </div>
                </div>
            </div>
            
            <!-- Summary Totals -->
            <div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-4 rounded-lg border" style="border-color: var(--border);">
                    <div class="text-sm" style="color: var(--muted);">Total Earned</div>
                    <div class="text-2xl font-bold" id="ledger-total-earned">$0.00</div>
                </div>
                <div class="p-4 rounded-lg border" style="border-color: var(--border);">
                    <div class="text-sm" style="color: var(--muted);">Total Paid</div>
                    <div class="text-2xl font-bold" style="color: var(--success);" id="ledger-total-paid">$0.00</div>
                </div>
                <div class="p-4 rounded-lg border" style="border-color: var(--border);">
                    <div class="text-sm" style="color: var(--muted);">Total Due Now</div>
                    <div class="text-2xl font-bold" style="color: var(--success);" id="ledger-total-due">$0.00</div>
                </div>
                <div class="p-4 rounded-lg border" style="border-color: var(--border);">
                    <div class="text-sm" style="color: var(--muted);">Total On Hold</div>
                    <div class="text-2xl font-bold" style="color: var(--warning);" id="ledger-total-hold">$0.00</div>
                </div>
            </div>
            
            <!-- Customer Breakdown -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Per-Customer Breakdown</h3>
                <div class="overflow-x-auto">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Model</th>
                                <th>Last Payment</th>
                                <th>Earned</th>
                                <th>Paid</th>
                                <th>Due Now</th>
                                <th>On Hold</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ledger-customer-breakdown">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Earning Events -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold">Earning Events</h3>
                    <div class="flex items-center gap-2">
                        <button onclick="selectAllDueEvents()" class="btn btn-outline btn-sm">Select All DUE</button>
                        <button onclick="clearSelection()" class="btn btn-outline btn-sm">Clear</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="select-all-events" onchange="toggleAllEvents(this.checked)">
                                </th>
                                <th>Customer</th>
                                <th>Amount</th>
                                <th>Payment Date</th>
                                <th>Eligible At</th>
                                <th>Paid</th>
                                <th>Paid Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ledger-events-breakdown">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>
                <div id="batch-selection-summary" class="mt-4 p-3 rounded-lg hidden" style="background: var(--muted-bg);">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-semibold" id="selected-count">0</span> events selected
                            <span class="ml-4">Total: <span class="font-semibold" id="selected-total">$0.00</span></span>
                        </div>
                        <button onclick="createBatchFromSelection()" class="btn btn-success btn-sm">
                            ‚úì Create Batch + Mark Paid
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex gap-4">
                <button onclick="closeModal('ledgerModal')" class="btn btn-outline flex-1">Close</button>
            </div>
        </div>
    </div>
    
    <!-- API Key Modals -->
    <div id="viewApiKeyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">API Key Details</h2>
                <button onclick="closeModal('viewApiKeyModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="api-key-content" class="space-y-4">
                <!-- Content loaded dynamically -->
            </div>
            <div class="mt-6 flex gap-4">
                <button onclick="copyApiKey()" class="btn btn-primary flex-1">üìã Copy API Key</button>
                <button onclick="closeModal('viewApiKeyModal')" class="btn btn-outline flex-1">Close</button>
            </div>
        </div>
    </div>
    
    <div id="regenerateApiKeyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Regenerate API Key</h2>
                <button onclick="closeModal('regenerateApiKeyModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <p class="mb-4">Are you sure you want to regenerate the API key for <strong id="regenerate-customer-email"></strong>?</p>
            <p class="text-sm text-red-600 mb-6">‚ö†Ô∏è The old API key will be invalidated immediately. The customer will receive an email with the new key.</p>
            <div class="flex gap-4">
                <button onclick="confirmRegenerateApiKey()" class="btn btn-warning flex-1">Yes, Regenerate</button>
                <button onclick="closeModal('regenerateApiKeyModal')" class="btn btn-outline flex-1">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="revokeApiKeyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Revoke API Access</h2>
                <button onclick="closeModal('revokeApiKeyModal')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <p class="mb-4">Are you sure you want to revoke API access for <strong id="revoke-customer-email"></strong>?</p>
            <p class="text-sm text-red-600 mb-6">‚ö†Ô∏è All API keys will be deactivated. The customer will receive an email notification.</p>
            <div class="flex gap-4">
                <button onclick="confirmRevokeApiKey()" class="btn btn-error flex-1">Yes, Revoke</button>
                <button onclick="closeModal('revokeApiKeyModal')" class="btn btn-outline flex-1">Cancel</button>
            </div>
        </div>
    </div>
    
    <script src="/admin-dashboard-v2.js?v={{CACHE_BUST}}"></script>
    <script>
        // User Management Form Handler
        document.getElementById('update-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const oldEmail = document.getElementById('old-email').value.trim();
            const newEmail = document.getElementById('new-email').value.trim();
            const newPassword = document.getElementById('new-password').value.trim();
            
            const successDiv = document.getElementById('update-user-success');
            const errorDiv = document.getElementById('update-user-error');
            const errorText = document.getElementById('update-user-error-text');
            const detailsDiv = document.getElementById('update-user-details');
            const submitButton = document.getElementById('update-user-button');
            
            // Hide previous messages
            successDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            
            // Validate inputs
            if (!newEmail || !newPassword) {
                errorText.textContent = 'New email and password are required';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (oldEmail && oldEmail === newEmail) {
                errorText.textContent = 'New email must be different from current email';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (newPassword.length < 8) {
                errorText.textContent = 'Password must be at least 8 characters';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Disable button and show loading
            submitButton.disabled = true;
            submitButton.textContent = oldEmail ? 'Updating...' : 'Creating...';
            
            try {
                // Use existing HTTP Basic Auth (browser handles it automatically)
                // old_email is optional - if empty, it will create a new user
                const url = `/api/admin/update-user-email?new_email=${encodeURIComponent(newEmail)}&new_password=${encodeURIComponent(newPassword)}${oldEmail ? `&old_email=${encodeURIComponent(oldEmail)}` : ''}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include' // Include credentials for HTTP Basic Auth
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    // Show success message
                    const oldEmailDisplay = data.old_email ? `<p><strong>Old Email:</strong> ${data.old_email}</p>` : '';
                    detailsDiv.innerHTML = `
                        ${oldEmailDisplay}
                        <p><strong>Email:</strong> ${data.new_email}</p>
                        <p><strong>Password:</strong> ${data.password}</p>
                        <p class="mt-2 font-medium" style="color: var(--success);">${data.note}</p>
                    `;
                    successDiv.classList.remove('hidden');
                    
                    // Reset form
                    document.getElementById('update-user-form').reset();
                    document.getElementById('new-password').value = 'TestPassword123!';
                } else {
                    // Show error message
                    errorText.textContent = data.detail || data.message || 'Failed to update user';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Update user error:', error);
                errorText.textContent = 'An error occurred. Please check the console for details.';
                errorDiv.classList.remove('hidden');
            } finally {
                // Re-enable button
                submitButton.disabled = false;
                const currentOldEmail = document.getElementById('old-email').value.trim();
                submitButton.textContent = currentOldEmail ? 'Update User' : 'Create User';
            }
        });
        
        function resetUpdateUserForm() {
            document.getElementById('update-user-form').reset();
            document.getElementById('new-password').value = 'TestPassword123!';
            document.getElementById('update-user-success').classList.add('hidden');
            document.getElementById('update-user-error').classList.add('hidden');
        }
    </script>
</body>
</html>

