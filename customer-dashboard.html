<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard - LienDeadline.com</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LW0FD04R7C"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LW0FD04R7C');
    </script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <!-- Lovable Scale Stylesheet (load first) -->
    <link rel="stylesheet" href="/lovable-scale.css">
    <style>
        /* CSS Variables for consistent theming */
        :root {
            --navy: hsl(220 60% 20%);
            --coral: #f97316;
            --coral-dark: #ea580c;
            --coral-light: #fb923c;
        }

        /* Beautiful visual design */
        .dashboard-container {
            background: linear-gradient(135deg, var(--navy), var(--coral));
            min-height: 100vh;
            padding: 2rem 0;
        }

        /* Beautiful calculator section */
        #calculator {
            margin: 2rem 0;
        }

        #calculator > div {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        #calculator > div:hover {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        /* Beautiful heading */
        #calculator h2 {
            font-family: 'Instrument Serif', serif;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--navy), var(--coral));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        /* Beautiful date input */
        #dash_invoice_date {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--coral);
            border-radius: 12px;
            font-size: 1.1rem;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #dash_invoice_date:hover {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        #dash_invoice_date:focus {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
            outline: none;
        }

        /* Beautiful state select */
        #dash_state {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--coral);
            border-radius: 12px;
            font-size: 1.1rem;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #dash_state:hover {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        #dash_state:focus {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
            outline: none;
        }

        /* Beautiful button */
        #dash_calc_btn {
            background: linear-gradient(135deg, var(--coral), var(--coral-dark));
            border: none;
            border-radius: 50px;
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }

        #dash_calc_btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(249, 115, 22, 0.4);
            background: linear-gradient(135deg, var(--coral-dark), var(--coral));
        }

        #dash_calc_btn:active:not(:disabled) {
            transform: translateY(0);
        }

        #dash_calc_btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Beautiful results */
        #dash_results {
            margin-top: 3rem;
        }

        #dash_results > div {
            transition: all 0.3s ease;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .result-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-4px);
        }

        /* Beautiful error messages */
        #dash_calc_error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: #dc2626;
            font-weight: 500;
        }

        /* Beautiful PDF button */
        #dash_pdf_btn {
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 12px;
            padding: 1rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        #dash_pdf_btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669, #10b981);
        }

        /* Beautiful labels */
        #dash_calc_form label {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 0.5rem;
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            #calculator > div {
                padding: 2rem 1.5rem;
                margin: 1rem;
                border-radius: 16px;
            }

            #calculator h2 {
                font-size: 2rem;
            }

            #dash_calc_btn {
                width: 100%;
                padding: 1rem;
                font-size: 1.1rem;
            }

            #dash_invoice_date,
            #dash_state {
                padding: 0.875rem;
                font-size: 1rem;
            }

            .result-card {
                padding: 1.5rem;
            }
        }

        /* Loading animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Beautiful focus states */
        .focus-ring:focus {
            outline: none;
            ring: 2px;
            ring-color: var(--coral);
            ring-opacity: 0.5;
        }

        /* Enhanced result cards */
        #dash_prelim_card,
        #dash_lien_card {
            position: relative;
            overflow: hidden;
        }

        #dash_prelim_card::before,
        #dash_lien_card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--coral);
            transition: width 0.3s ease;
        }

        #dash_prelim_card:hover::before,
        #dash_lien_card:hover::before {
            width: 6px;
        }

        /* Beautiful serving requirements */
        #dash_serving_list li {
            transition: all 0.2s ease;
        }

        #dash_serving_list li:hover {
            transform: translateX(4px);
            color: var(--coral-dark);
        }

        /* Beautiful warnings section */
        #dash_warnings_section {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
    <script>
        // Check authentication on page load
        async function checkAuth() {
            const token = localStorage.getItem('session_token');
            
            if (!token) {
                window.location.href = '/dashboard';
                return;
            }
            
            try {
                const response = await fetch('/api/verify-session', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    // Session invalid - redirect to login
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_email');
                    window.location.href = '/dashboard';
                    return;
                }
                
                const data = await response.json();
                
                // Display user email
                const userEmailEl = document.getElementById('user-email');
                if (userEmailEl) {
                    userEmailEl.textContent = data.email;
                }
                
                // Check subscription status
                if (data.subscription_status === 'cancelled') {
                    // Show subscription warning (you can add UI for this)
                    console.warn('Subscription cancelled');
                }
                
            } catch (err) {
                console.error('Auth check failed:', err);
                window.location.href = '/dashboard';
            }
        }
        
        // Logout function
        function logout() {
            const token = localStorage.getItem('session_token');
            
            fetch('/api/logout', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }).finally(() => {
                localStorage.removeItem('session_token');
                localStorage.removeItem('user_email');
                window.location.href = '/dashboard';
            });
        }
        
        // Run on page load
        window.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-xl font-bold text-gray-900">Customer Dashboard</h1>
                <div class="flex gap-4 items-center">
                    <a href="#calculator" onclick="scrollToCalculator(event)" class="text-gray-600 hover:text-gray-900">Calculator</a>
                    <span id="user-email" class="text-sm text-gray-600"></span>
                    <a href="index.html" class="text-gray-600 hover:text-gray-900">Landing Page</a>
                    <button onclick="logout()" class="text-red-600 hover:text-red-700">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Account Overview -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Account Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <div class="text-sm text-gray-600 mb-1">Plan</div>
                    <div class="text-xl font-semibold text-gray-900">$299/month</div>
                    <div class="text-sm text-gray-500">Unlimited API calls</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-1">Status</div>
                    <div class="text-xl font-semibold text-green-600">Active</div>
                    <div class="text-sm text-gray-500">Next billing: Dec 23, 2025</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-1">API Calls This Month</div>
                    <div class="text-xl font-semibold text-gray-900">1,247</div>
                    <div class="text-sm text-gray-500">Unlimited plan</div>
                </div>
            </div>
        </div>

        <!-- Deadline Calculator (DASHBOARD - BEAUTIFUL DESIGN) -->
        <section id="calculator" class="mb-8">
            <div>
                <h2 class="mb-2">Deadline Calculator</h2>
                <p class="text-gray-600 mb-6 text-lg">Calculate mechanics lien deadlines instantly (unlimited for active customers).</p>
                
                <form id="dash_calc_form" class="space-y-8">
                    <div class="grid sm:grid-cols-2 gap-6">
                        <!-- Date Input -->
                        <div>
                            <label class="block text-lg font-medium text-foreground mb-3">
                                Invoice / Delivery Date
                            </label>
                            <input
                                id="dash_invoice_date"
                                name="invoice_date"
                                type="date"
                                required
                                class="w-full h-16 px-5 rounded-xl border-2 border-border bg-white text-foreground text-lg focus:outline-none focus:ring-4 focus:ring-accent/20 focus:border-accent transition-all"
                            />
                        </div>
                        
                        <!-- State Select -->
                        <div>
                            <label class="block text-lg font-medium text-foreground mb-3">
                                State
                            </label>
                            <select
                                id="dash_state"
                                name="state"
                                required
                                class="w-full h-16 px-5 rounded-xl border-2 border-border bg-white text-foreground text-lg focus:outline-none focus:ring-4 focus:ring-accent/20 focus:border-accent transition-all"
                            >
                                <option value="">Select a state...</option>
                                <option value="AL">Alabama</option>
                                <option value="AZ">Arizona</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="KY">Kentucky</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MD">Maryland</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="NC">North Carolina</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NV">Nevada</option>
                                <option value="NY">New York</option>
                                <option value="OH">Ohio</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="SC">South Carolina</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WI">Wisconsin</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- CTA Button -->
                    <button
                        type="submit"
                        id="dash_calc_btn"
                        class="w-full h-16 px-6 rounded-xl bg-accent text-white font-semibold hover:bg-accent/90 transition-all flex items-center justify-center gap-3 text-xl shadow-lg hover:shadow-xl"
                    >
                        Calculate Deadlines
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                        </svg>
                    </button>
                    <p id="dash_calc_error" class="hidden mt-3 text-sm text-red-600"></p>
                </form>
                
                <!-- Results Panel -->
                <div id="dash_results" class="hidden mt-10 space-y-6">
                    <!-- Results will be inserted here -->
                </div>
            </div>
        </section>

        <script>
            (function () {
                // UTC Date Parsing (CRITICAL - prevents timezone shifting)
                function parseISODateAsUTC(iso) {
                    const [y, m, d] = iso.split("-").map(Number);
                    return new Date(Date.UTC(y, m - 1, d));
                }

                function formatDateUTC(dateStr) {
                    // Parse as UTC to avoid timezone shifts
                    const date = parseISODateAsUTC(dateStr);
                    return new Intl.DateTimeFormat('en-US', {
                        timeZone: 'UTC',
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }).format(date);
                }

                function formatDateShortUTC(dateStr) {
                    const date = parseISODateAsUTC(dateStr);
                    return new Intl.DateTimeFormat('en-US', {
                        timeZone: 'UTC',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    }).format(date);
                }

                function getUrgencyColor(urgency) {
                    switch(urgency) {
                        case 'critical': return 'border-red-500';
                        case 'warning': return 'border-yellow-500';
                        default: return 'border-green-500';
                    }
                }

                function getUrgencyTextColor(urgency) {
                    switch(urgency) {
                        case 'critical': return 'text-red-600';
                        case 'warning': return 'text-yellow-600';
                        default: return 'text-green-600';
                    }
                }

                function formatServing(requirement) {
                    const map = {
                        'property_owner': 'Property Owner',
                        'original_contractor': 'Original Contractor',
                        'direct_contractor': 'Direct Contractor',
                        'construction_lender': 'Construction Lender'
                    };
                    return map[requirement] || requirement;
                }

                const form = document.getElementById("dash_calc_form");
                const btn = document.getElementById("dash_calc_btn");
                const err = document.getElementById("dash_calc_error");
                const resultsWrap = document.getElementById("dash_results");

                function showError(message) {
                    err.textContent = message || "Something went wrong.";
                    err.classList.remove("hidden");
                }

                function clearError() {
                    err.textContent = "";
                    err.classList.add("hidden");
                }

                function getSessionToken() {
                    return (
                        localStorage.getItem("session_token") ||
                        localStorage.getItem("sessionToken") ||
                        sessionStorage.getItem("session_token") ||
                        sessionStorage.getItem("sessionToken") ||
                        ""
                    );
                }

                function displayDashboardResults(data) {
                    // Clear previous results
                    resultsWrap.innerHTML = '';

                    // Preliminary Notice Card
                    const prelimCard = document.createElement('div');
                    prelimCard.id = 'dash_prelim_card';
                    const prelimUrgency = data.preliminary_notice?.urgency || 'normal';
                    prelimCard.className = `result-card bg-white shadow-lg rounded-lg p-6 border-l-4 ${getUrgencyColor(prelimUrgency)}`;
                    prelimCard.innerHTML = `
                        <h3 class="text-xl font-bold mb-4" id="dash_prelim_title">${data.preliminary_notice?.name || 'Preliminary Notice'}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Deadline</p>
                                <p class="text-2xl font-bold" id="dash_prelim_date">${data.preliminary_notice?.deadline ? formatDateUTC(data.preliminary_notice.deadline) : 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Days From Now</p>
                                <p class="text-2xl font-bold ${getUrgencyTextColor(prelimUrgency)}" id="dash_prelim_days">${data.preliminary_notice?.days_from_now || 'N/A'} days</p>
                            </div>
                        </div>
                        <p class="mt-4 text-sm text-gray-600" id="dash_prelim_description">${data.preliminary_notice?.description || ''}</p>
                    `;
                    resultsWrap.appendChild(prelimCard);

                    // Lien Filing Card
                    const lienCard = document.createElement('div');
                    lienCard.id = 'dash_lien_card';
                    const lienUrgency = data.lien_filing?.urgency || 'normal';
                    lienCard.className = `result-card bg-white shadow-lg rounded-lg p-6 border-l-4 ${getUrgencyColor(lienUrgency)}`;
                    lienCard.innerHTML = `
                        <h3 class="text-xl font-bold mb-4" id="dash_lien_title">${data.lien_filing?.name || 'Lien Filing Deadline'}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Deadline</p>
                                <p class="text-2xl font-bold" id="dash_lien_date">${data.lien_filing?.deadline ? formatDateUTC(data.lien_filing.deadline) : 'N/A'}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Days From Now</p>
                                <p class="text-2xl font-bold ${getUrgencyTextColor(lienUrgency)}" id="dash_lien_days">${data.lien_filing?.days_from_now || 'N/A'} days</p>
                            </div>
                        </div>
                        <p class="mt-4 text-sm text-gray-600" id="dash_lien_description">${data.lien_filing?.description || ''}</p>
                    `;
                    resultsWrap.appendChild(lienCard);

                    // Serving Requirements
                    if (data.serving_requirements && data.serving_requirements.length > 0) {
                        const servingDiv = document.createElement('div');
                        servingDiv.className = 'bg-blue-50 rounded-lg p-6';
                        servingDiv.innerHTML = '<h4 class="font-bold text-lg mb-3">Must Serve:</h4><ul id="dash_serving_list" class="space-y-2"></ul>';
                        const servingList = servingDiv.querySelector('#dash_serving_list');
                        data.serving_requirements.forEach(req => {
                            const li = document.createElement('li');
                            li.className = 'flex items-center text-gray-700';
                            li.innerHTML = `
                                <svg class="h-5 w-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                ${formatServing(req)}
                            `;
                            servingList.appendChild(li);
                        });
                        resultsWrap.appendChild(servingDiv);
                    }

                    // Critical Warnings
                    if (data.critical_warnings && data.critical_warnings.length > 0) {
                        const warningsDiv = document.createElement('div');
                        warningsDiv.id = 'dash_warnings_section';
                        warningsDiv.className = 'bg-red-50 border-l-4 border-red-400 p-6';
                        warningsDiv.innerHTML = '<h4 class="font-bold text-lg mb-3 text-red-800">‚ö†Ô∏è Critical Warnings:</h4><ul id="dash_warnings_list" class="space-y-2"></ul>';
                        const warningsList = warningsDiv.querySelector('#dash_warnings_list');
                        data.critical_warnings.forEach(warning => {
                            const li = document.createElement('li');
                            li.className = 'text-red-700 text-sm';
                            li.textContent = warning;
                            warningsList.appendChild(li);
                        });
                        resultsWrap.appendChild(warningsDiv);
                    }

                    // Statute Citations
                    if (data.statute_citations && data.statute_citations.length > 0) {
                        const citationsDiv = document.createElement('div');
                        citationsDiv.className = 'bg-gray-50 rounded-lg p-6';
                        citationsDiv.innerHTML = '<h4 class="font-bold text-lg mb-3">Legal References:</h4><ul id="dash_citations_list" class="space-y-1 text-sm text-gray-600"></ul>';
                        const citationsList = citationsDiv.querySelector('#dash_citations_list');
                        data.statute_citations.forEach(citation => {
                            const li = document.createElement('li');
                            li.textContent = citation;
                            citationsList.appendChild(li);
                        });
                        resultsWrap.appendChild(citationsDiv);
                    }

                    // PDF Download Button
                    const pdfDiv = document.createElement('div');
                    pdfDiv.className = 'flex flex-col sm:flex-row gap-4';
                    const stateCode = document.getElementById('dash_state').value.toUpperCase();
                    pdfDiv.innerHTML = `
                        <a id="dash_pdf_btn" href="/api/v1/guide/${stateCode}/pdf" target="_blank" class="flex-1 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-200 text-center">
                            üìÑ Download PDF Report
                        </a>
                    `;
                    resultsWrap.appendChild(pdfDiv);

                    // Show results
                    resultsWrap.classList.remove('hidden');
                    resultsWrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                form.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    clearError();

                    const invoice_date = document.getElementById("dash_invoice_date").value;
                    const state = document.getElementById("dash_state").value;

                    if (!invoice_date || !state) {
                        showError("Please select a date and a state.");
                        return;
                    }

                    btn.disabled = true;
                    btn.innerHTML = 'Calculating... <svg class="animate-spin h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

                    try {
                        const token = getSessionToken();
                        const headers = { "Content-Type": "application/json" };
                        if (token) headers["Authorization"] = "Bearer " + token;

                        const resp = await fetch("/api/v1/calculate-deadline", {
                            method: "POST",
                            headers,
                            body: JSON.stringify({ invoice_date, state })
                        });

                        const data = await resp.json();
                        if (!resp.ok) {
                            showError(data?.detail || data?.message || "Calculation failed.");
                            return;
                        }

                        // Display results using dashboard-specific renderer
                        displayDashboardResults(data);

                    } catch (ex) {
                        showError("Network error. Please try again.");
                        console.error(ex);
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = `
                            Calculate Deadlines
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                            </svg>
                        `;
                    }
                });
            })();
        </script>

        <!-- API Key Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Your API Key</h2>
            <div class="flex items-center gap-4">
                <input type="text" id="api-key" value="sk_live_1a2b3c4d5e6f7g8h" readonly class="flex-1 px-4 py-2 border border-gray-300 rounded-md bg-gray-50 font-mono">
                <button onclick="toggleApiKey()" id="toggle-key-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 font-semibold">Reveal</button>
                <button onclick="copyApiKey()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">Copy</button>
                <button onclick="regenerateApiKey()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-semibold">Regenerate</button>
            </div>
            <p class="text-sm text-gray-500 mt-2">Keep your API key secret. Never share it publicly.</p>
        </div>

        <!-- Usage Stats -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Usage This Month</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="text-sm text-gray-600 mb-2">Total API Calls</div>
                    <div class="text-3xl font-bold text-gray-900">1,247</div>
                    <div class="text-sm text-gray-500 mt-1">Last 30 days</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-2">States Used</div>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">TX</span>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">CA</span>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">FL</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Billing Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Billing</h2>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-semibold">Current Plan</div>
                        <div class="text-sm text-gray-600">$299/month (Unlimited)</div>
                    </div>
                    <button onclick="openStripePortal()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">
                        Manage Billing
                    </button>
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-semibold">Payment Method</div>
                        <button onclick="updatePayment()" class="text-blue-600 hover:text-blue-700 text-sm">Update</button>
                    </div>
                    <div class="text-sm text-gray-600">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</div>
                </div>
                <div class="border-t pt-4">
                    <div class="font-semibold mb-2">Next Charge</div>
                    <div class="text-sm text-gray-600">$299 on Dec 23, 2025</div>
                </div>
                <div class="border-t pt-4">
                    <button onclick="viewInvoices()" class="text-blue-600 hover:text-blue-700 text-sm font-semibold">View Invoices ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- API Documentation Link -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-2">API Documentation</h2>
            <p class="text-gray-700 mb-4">Learn how to integrate our API into your application.</p>
            <a href="/test-api" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">
                View API Docs ‚Üí
            </a>
        </div>
    </div>

    <script>
        let apiKeyVisible = false;
        let fullApiKey = ''; // Store full key

        // Initialize API key masking on page load
        window.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('api-key');
            if (input) {
                fullApiKey = input.value;
                maskApiKey();
            }
        });

        function maskApiKey() {
            const input = document.getElementById('api-key');
            const btn = document.getElementById('toggle-key-btn');
            
            if (fullApiKey) {
                // Show only prefix (first 12 chars) + ellipsis + last 4 chars
                const prefix = fullApiKey.substring(0, 12);
                const suffix = fullApiKey.substring(fullApiKey.length - 4);
                input.value = prefix + '‚Ä¶' + suffix;
                btn.textContent = 'Reveal';
                apiKeyVisible = false;
            }
        }

        function toggleApiKey() {
            const input = document.getElementById('api-key');
            const btn = document.getElementById('toggle-key-btn');
            
            if (apiKeyVisible) {
                maskApiKey();
            } else {
                input.value = fullApiKey;
                btn.textContent = 'Hide';
                apiKeyVisible = true;
            }
        }

        function copyApiKey() {
            // Always copy the full key, even if masked
            navigator.clipboard.writeText(fullApiKey).then(() => {
                alert('‚úÖ API key copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const input = document.getElementById('api-key');
                const originalValue = input.value;
                input.value = fullApiKey;
                input.select();
                document.execCommand('copy');
                input.value = originalValue;
                alert('‚úÖ API key copied to clipboard!');
            });
        }

        function scrollToCalculator(event) {
            event.preventDefault();
            const calculatorSection = document.getElementById('calculator');
            if (calculatorSection) {
                calculatorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function regenerateApiKey() {
            if (confirm('‚ö†Ô∏è Regenerating your API key will invalidate the current key. Continue?')) {
                // In production, call API to regenerate
                const newKey = 'sk_live_' + Math.random().toString(36).substr(2, 16);
                document.getElementById('api-key').value = newKey;
                alert('‚úÖ New API key generated!');
            }
        }

        async function openStripePortal() {
            // In production, call: POST /admin/portal
            try {
                const response = await fetch('/admin/portal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('customer_token')
                    },
                    body: JSON.stringify({
                        customer_id: localStorage.getItem('customer_id')
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    window.open(data.url, '_blank');
                } else {
                    throw new Error('Failed to create portal session');
                }
            } catch (error) {
                // Fallback for demo
                alert('Redirecting to Stripe billing portal...\n\nIn production, this opens: https://billing.stripe.com/p/session/...');
            }
        }

        function updatePayment() {
            alert('Opening payment method update...\n\nIn production, opens Stripe payment form.');
        }

        function viewInvoices() {
            alert('Opening invoices...\n\nIn production, shows list of invoices from Stripe.');
        }

        function logout() {
            if (confirm('Logout?')) {
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>

