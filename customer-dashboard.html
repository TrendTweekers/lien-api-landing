<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deadline Dashboard - LienDeadline.com</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KYZG0TN07Z"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KYZG0TN07Z');
    </script>
    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="02250d35-ee17-41be-845d-2fe0f7f15e63"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <!-- Lovable Scale Stylesheet (load first) -->
    <link rel="stylesheet" href="/lovable-scale.css">
    <style>
        /* CSS Variables for consistent theming */
        :root {
            --navy: hsl(220 60% 20%);
            --coral: #f97316;
            --coral-dark: #ea580c;
            --coral-light: #fb923c;
        }

        /* Beautiful visual design */
        .dashboard-container {
            background: linear-gradient(135deg, var(--navy), var(--coral));
            min-height: 100vh;
            padding: 2rem 0;
        }

        /* Beautiful calculator section */
        #calculator {
            margin: 2rem 0;
        }

        #calculator > div {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        #calculator > div:hover {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        /* Beautiful heading */
        #calculator h2 {
            font-family: 'Instrument Serif', serif;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--navy), var(--coral));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        /* Beautiful date input */
        #dash_invoice_date {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--coral);
            border-radius: 12px;
            font-size: 1.1rem;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #dash_invoice_date:hover {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        #dash_invoice_date:focus {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
            outline: none;
        }

        /* Beautiful state select */
        #dash_state {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--coral);
            border-radius: 12px;
            font-size: 1.1rem;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #dash_state:hover {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        #dash_state:focus {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
            outline: none;
        }

        /* Beautiful button */
        #dash_calc_btn {
            background: linear-gradient(135deg, var(--coral), var(--coral-dark));
            border: none;
            border-radius: 50px;
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }

        #dash_calc_btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(249, 115, 22, 0.4);
            background: linear-gradient(135deg, var(--coral-dark), var(--coral));
        }

        #dash_calc_btn:active:not(:disabled) {
            transform: translateY(0);
        }

        #dash_calc_btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Beautiful results */
        #dash_results {
            margin-top: 3rem;
        }

        #dash_results > div {
            transition: all 0.3s ease;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .result-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-4px);
        }

        /* Beautiful error messages */
        #dash_calc_error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: #dc2626;
            font-weight: 500;
        }

        /* Beautiful PDF button */
        #dash_pdf_btn {
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 12px;
            padding: 1rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        #dash_pdf_btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669, #10b981);
        }

        /* Beautiful labels */
        #dash_calc_form label {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 0.5rem;
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            #calculator > div {
                padding: 2rem 1.5rem;
                margin: 1rem;
                border-radius: 16px;
            }

            #calculator h2 {
                font-size: 2rem;
            }

            #dash_calc_btn {
                width: 100%;
                padding: 1rem;
                font-size: 1.1rem;
            }

            #dash_invoice_date,
            #dash_state {
                padding: 0.875rem;
                font-size: 1rem;
            }

            .result-card {
                padding: 1.5rem;
            }
        }

        /* Loading animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Beautiful focus states */
        .focus-ring:focus {
            outline: none;
            ring: 2px;
            ring-color: var(--coral);
            ring-opacity: 0.5;
        }

        /* Enhanced result cards */
        #dash_prelim_card,
        #dash_lien_card {
            position: relative;
            overflow: hidden;
        }

        #dash_prelim_card::before,
        #dash_lien_card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--coral);
            transition: width 0.3s ease;
        }

        #dash_prelim_card:hover::before,
        #dash_lien_card:hover::before {
            width: 6px;
        }

        /* Beautiful serving requirements */
        #dash_serving_list li {
            transition: all 0.2s ease;
        }

        #dash_serving_list li:hover {
            transform: translateX(4px);
            color: var(--coral-dark);
        }

        /* Beautiful warnings section */
        #dash_warnings_section {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
    <script>
        // Check authentication on page load
        async function checkAuth() {
            const token = localStorage.getItem('session_token');
            
            if (!token) {
                window.location.href = '/dashboard';
                return;
            }
            
            try {
                const response = await fetch('/api/verify-session', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    // Session invalid - redirect to login
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_email');
                    window.location.href = '/dashboard';
                    return;
                }
                
                const data = await response.json();
                
                // Display user email
                const userEmailEl = document.getElementById('user-email');
                if (userEmailEl) {
                    userEmailEl.textContent = data.email;
                }
                
                // Check subscription status
                if (data.subscription_status === 'cancelled') {
                    // Show subscription warning (you can add UI for this)
                    console.warn('Subscription cancelled');
                }
                
            } catch (err) {
                console.error('Auth check failed:', err);
                window.location.href = '/dashboard';
            }
        }
        
        // Logout function
        function logout() {
            const token = localStorage.getItem('session_token');
            
            fetch('/api/logout', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }).finally(() => {
                localStorage.removeItem('session_token');
                localStorage.removeItem('user_email');
                window.location.href = '/dashboard';
            });
        }
        
        // Run on page load
        window.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <h1 class="text-xl font-bold text-gray-900">Deadline Dashboard</h1>
                <div class="flex gap-4 items-center">
                    <a href="#calculator" onclick="scrollToCalculator(event)" class="text-gray-600 hover:text-gray-900">Calculator</a>
                    <span id="user-email" class="text-sm text-gray-600"></span>
                    <a href="index.html" class="text-gray-600 hover:text-gray-900">Landing Page</a>
                    <button onclick="logout()" class="text-red-600 hover:text-red-700">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- QuickBooks Integration Section -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8" id="quickbooks-section">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <svg class="w-12 h-12 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 22C6.486 22 2 17.514 2 12S6.486 2 12 2s10 4.486 10 10-4.486 10-10 10z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">QuickBooks Integration</h3>
                        <p class="text-sm text-gray-600">Import invoices and auto-calculate lien deadlines</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="qb-status" class="text-sm text-gray-600"></span>
                    <button 
                        onclick="connectQuickBooks()"
                        id="qb-connect-btn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
                    >
                        Connect QuickBooks
                    </button>
                </div>
            </div>
            
            <div id="qb-invoices" class="mt-6 hidden">
                <!-- Invoice list will appear here after connection -->
            </div>
        </div>

        <!-- Account Overview -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Account Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <div class="text-sm text-gray-600 mb-1">Plan</div>
                    <div class="text-xl font-semibold text-gray-900">$299/month</div>
                    <div class="text-sm text-gray-500">Unlimited API calls</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-1">Status</div>
                    <div class="text-xl font-semibold text-green-600">Active</div>
                    <div class="text-sm text-gray-500">Next billing: Dec 23, 2025</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-1">API Calls This Month</div>
                    <div class="text-xl font-semibold text-gray-900">1,247</div>
                    <div class="text-sm text-gray-500">Unlimited plan</div>
                </div>
            </div>
        </div>

        <!-- Calculator Section (Updated to match working homepage calculator) -->
        <div class="bg-white shadow-lg rounded-lg p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6">Calculate New Deadline</h2>
            
            <form id="dashboardCalculatorForm" class="space-y-4">
                <!-- Invoice Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Invoice/Delivery Date</label>
                    <input 
                        type="date" 
                        id="dashInvoiceDate" 
                        name="invoice_date"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>
                
                <!-- State Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                    <select 
                        id="dashState" 
                        name="state"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">Select a state...</option>
                        <option value="AL">Alabama</option>
                        <option value="AK">Alaska</option>
                        <option value="AZ">Arizona</option>
                        <option value="AR">Arkansas</option>
                        <option value="CA">California</option>
                        <option value="CO">Colorado</option>
                        <option value="CT">Connecticut</option>
                        <option value="DE">Delaware</option>
                        <option value="DC">District of Columbia</option>
                        <option value="FL">Florida</option>
                        <option value="GA">Georgia</option>
                        <option value="HI">Hawaii</option>
                        <option value="ID">Idaho</option>
                        <option value="IL">Illinois</option>
                        <option value="IN">Indiana</option>
                        <option value="IA">Iowa</option>
                        <option value="KS">Kansas</option>
                        <option value="KY">Kentucky</option>
                        <option value="LA">Louisiana</option>
                        <option value="ME">Maine</option>
                        <option value="MD">Maryland</option>
                        <option value="MA">Massachusetts</option>
                        <option value="MI">Michigan</option>
                        <option value="MN">Minnesota</option>
                        <option value="MS">Mississippi</option>
                        <option value="MO">Missouri</option>
                        <option value="MT">Montana</option>
                        <option value="NE">Nebraska</option>
                        <option value="NV">Nevada</option>
                        <option value="NH">New Hampshire</option>
                        <option value="NJ">New Jersey</option>
                        <option value="NM">New Mexico</option>
                        <option value="NY">New York</option>
                        <option value="NC">North Carolina</option>
                        <option value="ND">North Dakota</option>
                        <option value="OH">Ohio</option>
                        <option value="OK">Oklahoma</option>
                        <option value="OR">Oregon</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="RI">Rhode Island</option>
                        <option value="SC">South Carolina</option>
                        <option value="SD">South Dakota</option>
                        <option value="TN">Tennessee</option>
                        <option value="TX">Texas</option>
                        <option value="UT">Utah</option>
                        <option value="VT">Vermont</option>
                        <option value="VA">Virginia</option>
                        <option value="WA">Washington</option>
                        <option value="WV">West Virginia</option>
                        <option value="WI">Wisconsin</option>
                        <option value="WY">Wyoming</option>
                    </select>
                </div>
                
                <!-- Role Selection (conditional - shown for WA) -->
                <div id="role-field" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Role</label>
                    <select 
                        id="dashRole" 
                        name="role"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="supplier">Material Supplier</option>
                        <option value="subcontractor">Subcontractor</option>
                        <option value="contractor">General Contractor</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Required for Washington state</p>
                </div>
                
                <!-- Project Type (conditional - shown for TX, OH) -->
                <div id="project-type-field" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Project Type</label>
                    <select 
                        id="dashProjectType" 
                        name="project_type"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="commercial">Commercial</option>
                        <option value="residential">Residential</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Required for Texas and Ohio</p>
                </div>
                
                <!-- Notice of Completion (conditional - shown for CA) -->
                <div id="noc-field" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notice of Completion Date (if filed)</label>
                    <input 
                        type="date" 
                        id="dashNOCDate" 
                        name="notice_of_completion_date"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                    <p class="text-xs text-gray-500 mt-1">Optional - If owner filed Notice of Completion, deadline may shorten</p>
                </div>
                
                <button 
                    type="submit"
                    id="dashCalcBtn"
                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors"
                >
                    Calculate Deadlines
                </button>
            </form>
        </div>

        <!-- Calculation Results -->
        <div id="dashResults" class="hidden space-y-6 mb-8">
            <div id="dashPrelimCard" class="bg-white shadow-lg rounded-lg p-6 border-l-4">
                <h3 class="text-xl font-bold mb-4" id="dashPrelimTitle"></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Deadline</p>
                        <p class="text-2xl font-bold" id="dashPrelimDate"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Days From Now</p>
                        <p class="text-2xl font-bold" id="dashPrelimDays"></p>
                    </div>
                </div>
            </div>

            <div id="dashLienCard" class="bg-white shadow-lg rounded-lg p-6 border-l-4">
                <h3 class="text-xl font-bold mb-4" id="dashLienTitle"></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Deadline</p>
                        <p class="text-2xl font-bold" id="dashLienDate"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Days From Now</p>
                        <p class="text-2xl font-bold" id="dashLienDays"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculation History -->
        <div class="bg-white shadow-lg rounded-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Your Calculation History</h2>
                <button id="exportCSV" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                    üìä Export to CSV
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">State</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prelim Deadline</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lien Deadline</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div id="noHistory" class="text-center py-8 text-gray-500">
                No calculations yet. Calculate your first deadline above!
            </div>
        </div>

        <!-- jsPDF library for PDF generation -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        
        <script>
            // Ported from dashboard.js with Authorization Bearer token support
            document.addEventListener('DOMContentLoaded', () => {
                loadHistory();
                
                // Set default date
                const dateInput = document.getElementById('dashInvoiceDate');
                if (dateInput) {
                    dateInput.valueAsDate = new Date();
                }
                
                // Initialize state change handler for conditional fields
                initStateChangeHandler();
            });

            // Get session token helper
            function getSessionToken() {
                return localStorage.getItem('session_token') || '';
            }

            // State change handler - show/hide conditional fields
            function initStateChangeHandler() {
                const stateSelect = document.getElementById('dashState');
                if (!stateSelect) return;
                
                stateSelect.addEventListener('change', function(e) {
                    const state = e.target.value.toUpperCase();
                    
                    // Show role field for Washington
                    const roleField = document.getElementById('role-field');
                    if (state === 'WA') {
                        roleField.style.display = 'block';
                        document.getElementById('dashRole').required = true;
                    } else {
                        roleField.style.display = 'none';
                        document.getElementById('dashRole').required = false;
                    }
                    
                    // Show project type for Texas, Ohio
                    const projectTypeField = document.getElementById('project-type-field');
                    if (state === 'TX' || state === 'OH') {
                        projectTypeField.style.display = 'block';
                        document.getElementById('dashProjectType').required = true;
                    } else {
                        projectTypeField.style.display = 'none';
                        document.getElementById('dashProjectType').required = false;
                    }
                    
                    // Show NOC field for California
                    const nocField = document.getElementById('noc-field');
                    if (state === 'CA') {
                        nocField.style.display = 'block';
                    } else {
                        nocField.style.display = 'none';
                    }
                });
            }

            // Dashboard Calculator Form Handler (with Authorization header and state-specific fields)
            document.getElementById('dashboardCalculatorForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const invoiceDate = document.getElementById('dashInvoiceDate').value;
                const state = document.getElementById('dashState').value.toUpperCase();
                
                if (!invoiceDate || !state) {
                    alert('Please enter both date and state');
                    return;
                }
                
                const submitButton = document.getElementById('dashCalcBtn');
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Calculating...';
                submitButton.disabled = true;
                
                try {
                    const token = getSessionToken();
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    if (token) {
                        headers['Authorization'] = 'Bearer ' + token;
                    }
                    
                    // Build request body with conditional fields
                    // API defaults: role="supplier", project_type="commercial"
                    const formData = {
                        invoice_date: invoiceDate,
                        state: state,
                        role: 'supplier', // Default
                        project_type: 'commercial' // Default
                    };
                    
                    // Override role for Washington (required)
                    if (state === 'WA') {
                        const role = document.getElementById('dashRole').value;
                        if (role) {
                            formData.role = role;
                        }
                    }
                    
                    // Override project type for Texas, Ohio (required)
                    if (state === 'TX' || state === 'OH') {
                        const projectType = document.getElementById('dashProjectType').value;
                        if (projectType) {
                            formData.project_type = projectType;
                        }
                    }
                    
                    // Add notice of completion date for California (optional)
                    if (state === 'CA') {
                        const nocDate = document.getElementById('dashNOCDate').value;
                        if (nocDate) {
                            formData.notice_of_completion_date = nocDate;
                        }
                    }
                    
                    const response = await fetch('/api/v1/calculate-deadline', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                        throw new Error(errorData.detail || errorData.error || `API returned ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Track GA4 event
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'calculator_submit', {
                            'event_category': 'Calculator',
                            'event_label': state,
                            'value': 1
                        });
                        
                        gtag('event', 'calculator_used', {
                            event_category: 'engagement',
                            event_label: 'lien_calculator'
                        });
                    }
                    
                    // Display results
                    displayDashboardResults(data);
                    
                    // Save to history
                    saveCalculation(data);
                    
                    // Reload history table
                    loadHistory();
                    
                    // Scroll to results
                    document.getElementById('dashResults').scrollIntoView({ behavior: 'smooth' });
                    
                } catch (error) {
                    console.error('Calculation error:', error);
                    alert('Error calculating deadline: ' + error.message);
                } finally {
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                }
            });

            function displayDashboardResults(data) {
                // Calculate urgency based on days remaining
                function getUrgency(daysFromNow) {
                    if (daysFromNow === null || daysFromNow === undefined) return 'normal';
                    if (daysFromNow <= 7) return 'critical';
                    if (daysFromNow <= 30) return 'warning';
                    return 'normal';
                }
                
                // Get urgency from API response or calculate it
                const prelimUrgency = data.preliminary_notice.urgency || 
                    getUrgency(data.preliminary_notice.days_from_now);
                const lienUrgency = data.lien_filing.urgency || 
                    getUrgency(data.lien_filing.days_from_now);
                
                document.getElementById('dashResults').classList.remove('hidden');
                
                // Preliminary Notice (only show if required)
                if (data.preliminary_notice.required) {
                    const prelimCard = document.getElementById('dashPrelimCard');
                    prelimCard.className = `bg-white shadow-lg rounded-lg p-6 border-l-4 ${getUrgencyColor(prelimUrgency)}`;
                    document.getElementById('dashPrelimTitle').textContent = 
                        data.preliminary_notice.name || 'Preliminary Notice Deadline';
                    document.getElementById('dashPrelimDate').textContent = 
                        data.preliminary_notice.deadline ? formatDate(data.preliminary_notice.deadline) : 'Not Required';
                    
                    const prelimDaysEl = document.getElementById('dashPrelimDays');
                    if (data.preliminary_notice.days_from_now !== null && data.preliminary_notice.days_from_now !== undefined) {
                        prelimDaysEl.textContent = `${data.preliminary_notice.days_from_now} days`;
                        prelimDaysEl.className = `text-2xl font-bold ${getUrgencyTextColor(prelimUrgency)}`;
                    } else {
                        prelimDaysEl.textContent = 'N/A';
                        prelimDaysEl.className = 'text-2xl font-bold text-gray-500';
                    }
                    prelimCard.style.display = 'block';
                } else {
                    // Hide preliminary notice card if not required
                    document.getElementById('dashPrelimCard').style.display = 'none';
                }
                
                // Lien Filing
                const lienCard = document.getElementById('dashLienCard');
                lienCard.className = `bg-white shadow-lg rounded-lg p-6 border-l-4 ${getUrgencyColor(lienUrgency)}`;
                document.getElementById('dashLienTitle').textContent = 
                    data.lien_filing.name || 'Lien Filing Deadline';
                document.getElementById('dashLienDate').textContent = 
                    data.lien_filing.deadline ? formatDate(data.lien_filing.deadline) : 'N/A';
                
                const lienDaysEl = document.getElementById('dashLienDays');
                if (data.lien_filing.days_from_now !== null && data.lien_filing.days_from_now !== undefined) {
                    lienDaysEl.textContent = `${data.lien_filing.days_from_now} days`;
                    lienDaysEl.className = `text-2xl font-bold ${getUrgencyTextColor(lienUrgency)}`;
                } else {
                    lienDaysEl.textContent = 'N/A';
                    lienDaysEl.className = 'text-2xl font-bold text-gray-500';
                }
                lienCard.style.display = 'block';
                
                // Show warnings if any
                if (data.warnings && data.warnings.length > 0) {
                    let warningsHtml = '<div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg mt-4"><h4 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Important Notes:</h4><ul class="list-disc list-inside text-yellow-700 space-y-1">';
                    data.warnings.forEach(warning => {
                        warningsHtml += `<li>${warning}</li>`;
                    });
                    warningsHtml += '</ul></div>';
                    
                    // Add warnings after results
                    const dashResults = document.getElementById('dashResults');
                    let warningsDiv = document.getElementById('dashWarnings');
                    if (!warningsDiv) {
                        warningsDiv = document.createElement('div');
                        warningsDiv.id = 'dashWarnings';
                        dashResults.appendChild(warningsDiv);
                    }
                    warningsDiv.innerHTML = warningsHtml;
                }
            }

            function saveCalculation(data) {
                // Get existing history
                let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
                
                // Add new calculation
                const calculation = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    invoice_date: data.invoice_date,
                    state: data.state_code || data.state,
                    state_name: data.state_name || data.state,
                    prelim_deadline: data.preliminary_notice?.deadline || null,
                    lien_deadline: data.lien_filing?.deadline || null,
                    prelim_days: data.preliminary_notice?.days_from_now || null,
                    lien_days: data.lien_filing?.days_from_now || null,
                    warnings: data.warnings || [],
                    data: data // Store full data for PDF generation
                };
                
                history.unshift(calculation); // Add to beginning
                
                // Keep only last 100 calculations
                if (history.length > 100) {
                    history = history.slice(0, 100);
                }
                
                localStorage.setItem('calculationHistory', JSON.stringify(history));
            }

            function loadHistory() {
                const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
                const tbody = document.getElementById('historyTableBody');
                const noHistory = document.getElementById('noHistory');
                
                if (history.length === 0) {
                    tbody.innerHTML = '';
                    noHistory.classList.remove('hidden');
                    return;
                }
                
                noHistory.classList.add('hidden');
                
                tbody.innerHTML = history.map(calc => `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${new Date(calc.timestamp).toLocaleDateString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${calc.invoice_date}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${calc.state}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${calc.prelim_deadline}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${calc.lien_deadline}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button onclick="downloadHistoryPDF(${calc.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                üìÑ PDF
                            </button>
                            <button onclick="deleteCalculation(${calc.id})" class="text-red-600 hover:text-red-900">
                                üóëÔ∏è Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            function deleteCalculation(id) {
                if (!confirm('Delete this calculation?')) return;
                
                let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
                history = history.filter(calc => calc.id !== id);
                localStorage.setItem('calculationHistory', JSON.stringify(history));
                loadHistory();
            }

            function downloadHistoryPDF(id) {
                const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
                const calc = history.find(c => c.id === id);
                
                if (calc && calc.data) {
                    generatePDF(calc.data);
                    
                    // Track GA4 event
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'pdf_download', {
                            'event_category': 'PDF',
                            'event_label': calc.state,
                            'value': 1
                        });
                    }
                } else {
                    alert('Unable to generate PDF. Please recalculate.');
                }
            }

            // Export to CSV
            document.getElementById('exportCSV').addEventListener('click', () => {
                const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
                
                if (history.length === 0) {
                    alert('No calculations to export');
                    return;
                }
                
                // Create CSV content
                const headers = ['Date', 'Invoice Date', 'State', 'Prelim Deadline', 'Lien Deadline'];
                const rows = history.map(calc => [
                    new Date(calc.timestamp).toLocaleDateString(),
                    calc.invoice_date,
                    calc.state,
                    calc.prelim_deadline,
                    calc.lien_deadline
                ]);
                
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.join(','))
                ].join('\n');
                
                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lien-calculations-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            });

            // Utility functions
            function getUrgencyColor(urgency) {
                switch(urgency) {
                    case 'critical': return 'border-red-500';
                    case 'warning': return 'border-yellow-500';
                    default: return 'border-green-500';
                }
            }

            function getUrgencyTextColor(urgency) {
                switch(urgency) {
                    case 'critical': return 'text-red-600';
                    case 'warning': return 'text-yellow-600';
                    default: return 'text-green-600';
                }
            }

            function formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }

            // PDF Generation (from dashboard.js)
            function generatePDF(data) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 20;
                let yPos = 20;
                
                // Header
                doc.setFontSize(24);
                doc.setTextColor(37, 99, 235);
                doc.text('LienDeadline', margin, yPos);
                
                yPos += 10;
                doc.setFontSize(18);
                doc.setTextColor(0, 0, 0);
                doc.text('Lien Deadline Report', margin, yPos);
                
                yPos += 5;
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated: ${new Date().toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}`, margin, yPos);
                
                yPos += 5;
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 10;
                
                // Project Information
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Project Information', margin, yPos);
                yPos += 7;
                
                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                // Use state_name if available, otherwise use state_code, fallback to state
                const displayState = data.state_name || (data.state_code ? getStateNameFromCode(data.state_code) : data.state) || 'Unknown';
                doc.text(`State: ${displayState}`, margin + 5, yPos);
                yPos += 6;
                doc.text(`Invoice Date: ${formatDate(data.invoice_date)}`, margin + 5, yPos);
                yPos += 6;
                if (data.role) {
                    doc.text(`Role: ${data.role.charAt(0).toUpperCase() + data.role.slice(1)}`, margin + 5, yPos);
                    yPos += 6;
                }
                yPos += 4;
                
                // Helper function for urgency calculation (used for both prelim and lien)
                function getUrgencyForPDF(daysFromNow) {
                    if (daysFromNow === null || daysFromNow === undefined) return 'normal';
                    if (daysFromNow <= 7) return 'critical';
                    if (daysFromNow <= 30) return 'warning';
                    return 'normal';
                }
                
                // Preliminary Notice (if required)
                if (data.preliminary_notice && data.preliminary_notice.required) {
                    const prelimUrgency = data.preliminary_notice.urgency || 
                        getUrgencyForPDF(data.preliminary_notice.days_from_now);
                    
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    doc.text(data.preliminary_notice.name || 'Preliminary Notice Deadline', margin, yPos);
                    yPos += 7;
                    
                    const prelimColor = getUrgencyPDFColor(prelimUrgency);
                    doc.setFillColor(prelimColor.r, prelimColor.g, prelimColor.b);
                    doc.rect(margin, yPos - 5, 5, 5, 'F');
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Deadline: ${data.preliminary_notice.deadline ? formatDate(data.preliminary_notice.deadline) : 'Not Required'}`, margin + 10, yPos);
                    yPos += 6;
                    
                    if (data.preliminary_notice.days_from_now !== null && data.preliminary_notice.days_from_now !== undefined) {
                        doc.setFontSize(10);
                        doc.setTextColor(prelimColor.r, prelimColor.g, prelimColor.b);
                        doc.text(`${data.preliminary_notice.days_from_now} days from now`, margin + 10, yPos);
                        yPos += 6;
                    }
                    
                    if (data.preliminary_notice.description) {
                        doc.setFontSize(9);
                        doc.setTextColor(100, 100, 100);
                        const prelimDesc = doc.splitTextToSize(data.preliminary_notice.description, pageWidth - margin * 2 - 10);
                        doc.text(prelimDesc, margin + 10, yPos);
                        yPos += prelimDesc.length * 5 + 5;
                    }
                }
                
                // Lien Filing
                // Reuse urgency calculation function (already defined above)
                const lienUrgency = data.lien_filing.urgency || 
                    getUrgencyForPDF(data.lien_filing.days_from_now);
                
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text(data.lien_filing.name || 'Lien Filing Deadline', margin, yPos);
                yPos += 7;
                
                const lienColor = getUrgencyPDFColor(lienUrgency);
                doc.setFillColor(lienColor.r, lienColor.g, lienColor.b);
                doc.rect(margin, yPos - 5, 5, 5, 'F');
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Deadline: ${data.lien_filing.deadline ? formatDate(data.lien_filing.deadline) : 'N/A'}`, margin + 10, yPos);
                yPos += 6;
                
                if (data.lien_filing.days_from_now !== null && data.lien_filing.days_from_now !== undefined) {
                    doc.setFontSize(10);
                    doc.setTextColor(lienColor.r, lienColor.g, lienColor.b);
                    doc.text(`${data.lien_filing.days_from_now} days from now`, margin + 10, yPos);
                    yPos += 6;
                }
                
                if (data.lien_filing.description) {
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    const lienDesc = doc.splitTextToSize(data.lien_filing.description, pageWidth - margin * 2 - 10);
                    doc.text(lienDesc, margin + 10, yPos);
                    yPos += lienDesc.length * 5 + 8;
                } else {
                    yPos += 8;
                }
                
                // Serving Requirements
                if (data.serving_requirements && data.serving_requirements.length > 0) {
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Must Serve:', margin, yPos);
                    yPos += 7;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(60, 60, 60);
                    data.serving_requirements.forEach(req => {
                        doc.text(`‚Ä¢ ${formatServing(req)}`, margin + 5, yPos);
                        yPos += 5;
                    });
                    yPos += 5;
                }
                
                // Critical Warnings
                if (data.critical_warnings && data.critical_warnings.length > 0) {
                    if (yPos > 220) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(12);
                    doc.setTextColor(220, 38, 38);
                    doc.text('‚ö† Critical Warnings:', margin, yPos);
                    yPos += 7;
                    
                    doc.setFontSize(9);
                    doc.setTextColor(153, 27, 27);
                    data.critical_warnings.forEach(warning => {
                        const warningText = doc.splitTextToSize(warning, pageWidth - margin * 2 - 5);
                        doc.text(warningText, margin + 5, yPos);
                        yPos += warningText.length * 5 + 3;
                    });
                    yPos += 5;
                }
                
                // Statute Citations
                if (data.statute_citations && data.statute_citations.length > 0) {
                    if (yPos > 220) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Legal References:', margin, yPos);
                    yPos += 7;
                    
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    data.statute_citations.forEach(citation => {
                        const citationText = doc.splitTextToSize(citation, pageWidth - margin * 2 - 5);
                        doc.text(citationText, margin + 5, yPos);
                        yPos += citationText.length * 4 + 2;
                    });
                    yPos += 8;
                }
                
                // Disclaimer
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFillColor(254, 252, 232);
                doc.rect(margin - 5, yPos - 5, pageWidth - margin * 2 + 10, 30, 'F');
                
                doc.setFontSize(10);
                doc.setTextColor(120, 53, 15);
                doc.text('DISCLAIMER', margin, yPos);
                yPos += 6;
                
                doc.setFontSize(8);
                doc.setTextColor(113, 63, 18);
                const disclaimer = doc.splitTextToSize(
                    'This is general information only, NOT legal advice. Always consult a licensed construction attorney before taking any legal action. Deadlines vary based on project specifics, and this tool cannot account for all variables. LienDeadline assumes no liability for missed deadlines or legal consequences.',
                    pageWidth - margin * 2
                );
                doc.text(disclaimer, margin, yPos);
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(
                        `Page ${i} of ${pageCount} | LienDeadline.com | Not Legal Advice`,
                        pageWidth / 2,
                        doc.internal.pageSize.getHeight() - 10,
                        { align: 'center' }
                    );
                }
                
                // Use state_code for filename, fallback to state if code not available
                const stateCode = data.state_code || data.state || 'UNKNOWN';
                const filename = `Lien-Deadline-Report-${stateCode}-${data.invoice_date}.pdf`;
                doc.save(filename);
            }

            function getUrgencyPDFColor(urgency) {
                switch(urgency) {
                    case 'critical': return { r: 220, g: 38, b: 38 };
                    case 'warning': return { r: 234, g: 179, b: 8 };
                    default: return { r: 34, g: 197, b: 94 };
                }
            }

            function formatServing(requirement) {
                const map = {
                    'property_owner': 'Property Owner',
                    'original_contractor': 'Original Contractor',
                    'direct_contractor': 'Direct Contractor',
                    'construction_lender': 'Construction Lender'
                };
                return map[requirement] || requirement;
            }
        </script>

        <!-- API Key Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Your API Key</h2>
            <div class="flex items-center gap-4">
                <input type="text" id="api-key" value="sk_live_1a2b3c4d5e6f7g8h" readonly class="flex-1 px-4 py-2 border border-gray-300 rounded-md bg-gray-50 font-mono">
                <button onclick="toggleApiKey()" id="toggle-key-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 font-semibold">Reveal</button>
                <button onclick="copyApiKey()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">Copy</button>
                <button onclick="regenerateApiKey()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-semibold">Regenerate</button>
            </div>
            <p class="text-sm text-gray-500 mt-2">Keep your API key secret. Never share it publicly.</p>
        </div>

        <!-- Usage Stats -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Usage This Month</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="text-sm text-gray-600 mb-2">Total API Calls</div>
                    <div class="text-3xl font-bold text-gray-900">1,247</div>
                    <div class="text-sm text-gray-500 mt-1">Last 30 days</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-2">States Used</div>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">TX</span>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">CA</span>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">FL</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Billing Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Billing</h2>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-semibold">Current Plan</div>
                        <div class="text-sm text-gray-600">$299/month (Unlimited)</div>
                    </div>
                    <button onclick="openStripePortal()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">
                        Manage Billing
                    </button>
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-semibold">Payment Method</div>
                        <button onclick="updatePayment()" class="text-blue-600 hover:text-blue-700 text-sm">Update</button>
                    </div>
                    <div class="text-sm text-gray-600">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</div>
                </div>
                <div class="border-t pt-4">
                    <div class="font-semibold mb-2">Next Charge</div>
                    <div class="text-sm text-gray-600">$299 on Dec 23, 2025</div>
                </div>
                <div class="border-t pt-4">
                    <button onclick="viewInvoices()" class="text-blue-600 hover:text-blue-700 text-sm font-semibold">View Invoices ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- API Documentation Link -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-2">API Documentation</h2>
            <p class="text-gray-700 mb-4">Learn how to integrate our API into your application.</p>
            <a href="/test-api" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">
                View API Docs ‚Üí
            </a>
        </div>
    </div>

    <script>
        let apiKeyVisible = false;
        let fullApiKey = ''; // Store full key

        // Initialize API key masking on page load
        window.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('api-key');
            if (input) {
                fullApiKey = input.value;
                maskApiKey();
            }
        });

        function maskApiKey() {
            const input = document.getElementById('api-key');
            const btn = document.getElementById('toggle-key-btn');
            
            if (fullApiKey) {
                // Show only prefix (first 12 chars) + ellipsis + last 4 chars
                const prefix = fullApiKey.substring(0, 12);
                const suffix = fullApiKey.substring(fullApiKey.length - 4);
                input.value = prefix + '‚Ä¶' + suffix;
                btn.textContent = 'Reveal';
                apiKeyVisible = false;
            }
        }

        function toggleApiKey() {
            const input = document.getElementById('api-key');
            const btn = document.getElementById('toggle-key-btn');
            
            if (apiKeyVisible) {
                maskApiKey();
            } else {
                input.value = fullApiKey;
                btn.textContent = 'Hide';
                apiKeyVisible = true;
            }
        }

        function copyApiKey() {
            // Always copy the full key, even if masked
            navigator.clipboard.writeText(fullApiKey).then(() => {
                alert('‚úÖ API key copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const input = document.getElementById('api-key');
                const originalValue = input.value;
                input.value = fullApiKey;
                input.select();
                document.execCommand('copy');
                input.value = originalValue;
                alert('‚úÖ API key copied to clipboard!');
            });
        }

        function scrollToCalculator(event) {
            event.preventDefault();
            const calculatorSection = document.getElementById('calculator');
            if (calculatorSection) {
                calculatorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function regenerateApiKey() {
            if (confirm('‚ö†Ô∏è Regenerating your API key will invalidate the current key. Continue?')) {
                // In production, call API to regenerate
                const newKey = 'sk_live_' + Math.random().toString(36).substr(2, 16);
                document.getElementById('api-key').value = newKey;
                alert('‚úÖ New API key generated!');
            }
        }

        async function openStripePortal() {
            // In production, call: POST /admin/portal
            try {
                const response = await fetch('/admin/portal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('customer_token')
                    },
                    body: JSON.stringify({
                        customer_id: localStorage.getItem('customer_id')
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    window.open(data.url, '_blank');
                } else {
                    throw new Error('Failed to create portal session');
                }
            } catch (error) {
                // Fallback for demo
                alert('Redirecting to Stripe billing portal...\n\nIn production, this opens: https://billing.stripe.com/p/session/...');
            }
        }

        function updatePayment() {
            alert('Opening payment method update...\n\nIn production, opens Stripe payment form.');
        }

        function viewInvoices() {
            alert('Opening invoices...\n\nIn production, shows list of invoices from Stripe.');
        }

        function logout() {
            if (confirm('Logout?')) {
                window.location.href = 'index.html';
            }
        }

        // QuickBooks Integration Functions
        async function connectQuickBooks() {
            const token = localStorage.getItem('session_token');
            if (!token) {
                alert('Please log in first');
                window.location.href = '/dashboard';
                return;
            }
            
            try {
                window.location.href = '/api/quickbooks/connect';
            } catch (error) {
                console.error('Error connecting to QuickBooks:', error);
                alert('Failed to connect to QuickBooks. Please try again.');
            }
        }

        async function checkQuickBooksStatus() {
            const token = localStorage.getItem('session_token');
            if (!token) return;

            try {
                const response = await fetch('/api/quickbooks/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const statusEl = document.getElementById('qb-status');
                    const connectBtn = document.getElementById('qb-connect-btn');
                    
                    if (data.connected) {
                        if (statusEl) {
                            statusEl.textContent = 'Connected';
                            statusEl.className = 'text-sm text-green-600 font-medium';
                        }
                        if (connectBtn) {
                            connectBtn.textContent = 'Reconnect';
                        }
                        loadQuickBooksInvoices();
                    } else {
                        if (statusEl) {
                            statusEl.textContent = 'Not connected';
                            statusEl.className = 'text-sm text-gray-600';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking QuickBooks status:', error);
            }
        }

        async function loadQuickBooksInvoices() {
            const token = localStorage.getItem('session_token');
            if (!token) return;

            try {
                const response = await fetch('/api/quickbooks/invoices', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Not connected
                        return;
                    }
                    throw new Error('Failed to load invoices');
                }
                
                const data = await response.json();
                displayQuickBooksInvoices(data.invoices || []);
            } catch (error) {
                console.error('Error loading QuickBooks invoices:', error);
            }
        }

        function displayQuickBooksInvoices(invoices) {
            const container = document.getElementById('qb-invoices');
            if (!container) return;
            
            if (!invoices || invoices.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            let html = '<h4 class="font-semibold text-lg mb-4 text-gray-900">Recent Invoices from QuickBooks</h4>';
            html += '<div class="space-y-3 max-h-96 overflow-y-auto">';
            
            invoices.forEach(inv => {
                const date = inv.date || 'N/A';
                const amount = inv.amount ? `$${inv.amount.toFixed(2)}` : '$0.00';
                const state = inv.state || '';
                const customer = escapeHtml(inv.customer || 'Unknown');
                
                html += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 hover:border-blue-300 transition">
                        <div class="flex justify-between items-center flex-wrap gap-4">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${customer}</p>
                                <p class="text-sm text-gray-600">Date: ${date} | Amount: ${amount}</p>
                                ${state ? `<p class="text-xs text-gray-500 mt-1">State: ${state}</p>` : ''}
                            </div>
                            <button 
                                onclick="calculateForInvoice('${date}', '${state}')"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap"
                            >
                                Calculate Deadline
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function calculateForInvoice(invoiceDate, state) {
            // Auto-fill calculator with invoice data
            const dateInput = document.getElementById('dashInvoiceDate');
            const stateSelect = document.getElementById('dashState');
            
            if (dateInput && invoiceDate) {
                dateInput.value = invoiceDate;
            }
            
            if (stateSelect && state && state.length === 2) {
                stateSelect.value = state;
            }
            
            // Scroll to calculator section
            const calculatorSection = document.getElementById('calculator');
            if (calculatorSection) {
                calculatorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Highlight the form
            if (dateInput) {
                dateInput.focus();
                setTimeout(() => {
                    dateInput.blur();
                }, 1000);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            // Simple notification function
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white ${
                type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            } shadow-lg z-50 transition-all`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Check if just connected from OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('qb_connected') === 'true') {
            setTimeout(() => {
                showNotification('QuickBooks connected successfully!', 'success');
                checkQuickBooksStatus();
            }, 500);
        }

        // Check QuickBooks status on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkQuickBooksStatus();
        });
    </script>
</body>
</html>

