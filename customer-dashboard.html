<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deadline Dashboard - LienDeadline.com</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KYZG0TN07Z"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KYZG0TN07Z');
    </script>
    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="02250d35-ee17-41be-845d-2fe0f7f15e63"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <!-- Lovable Scale Stylesheet (load first) -->
    <link rel="stylesheet" href="/lovable-scale.css">
    
    <script>
        // Check authentication on page load
        async function checkAuth() {
            const token = localStorage.getItem('session_token');

            // If no token, redirect to login page
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            // Verify the token is still valid
            try {
                const response = await fetch('/api/verify-session', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    // Token is invalid or expired
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = '/login.html';
                    return;
                }

                const data = await response.json();

                if (!data || !data.email) {
                    // Token is invalid
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = '/login.html';
                    return;
                }

                // Token is valid, continue with dashboard initialization
                // Display user email
                const userEmailEl = document.getElementById('user-email');
                if (userEmailEl) {
                    userEmailEl.textContent = data.email;
                }

                // Store email in localStorage for convenience
                if (data.email) {
                    localStorage.setItem('user_email', data.email);
                }

                // Check subscription status
                if (data.subscription_status === 'cancelled') {
                    console.warn('Subscription cancelled');
                }

                // Load dashboard data
                if (typeof loadDashboard === 'function') {
                    loadDashboard();
                }

            } catch (error) {
                console.error('Session verification error:', error);
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '/login.html';
                return;
            }
        }
        
        window.addEventListener('DOMContentLoaded', checkAuth);
    </script>

    <style>
        /* Minimal custom styles preserving animations */
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInToast {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutToast {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Smooth scroll */
        html { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- New Tailwind Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <a href="/">
                            <img class="h-8 w-auto" src="/images/liendeadline-logo.png" alt="LienDeadline">
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-email" class="text-sm text-gray-500 hidden md:block"></span>
                    <a href="/" onclick="localStorage.clear(); sessionStorage.clear();" class="text-gray-500 hover:text-red-600 px-3 py-2 rounded-md text-sm font-medium transition-colors">
                        Sign Out
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Beta Banner (Preserved) -->
        <div class="bg-amber-50 border-l-4 border-amber-500 p-4 mb-8 rounded-r-lg shadow-sm">
            <div class="flex">
                <div class="flex-shrink-0">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-amber-800">Beta Feature</h3>
                    <div class="mt-2 text-sm text-amber-700">
                        <p>Integrations are currently in beta testing. For now, we recommend manually entering invoice dates into the calculator below.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- LEFT COLUMN (Calculator, Results, Save Form) -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Calculator Section -->
                <div id="calculator" class="bg-white shadow-sm rounded-xl p-6 sm:p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Calculate New Deadline</h2>
                    
                    <form id="dashboardCalculatorForm" class="space-y-5">
                        <!-- Invoice Date -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Invoice/Delivery Date</label>
                            <input 
                                type="date" 
                                id="dashInvoiceDate" 
                                name="invoice_date"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-colors"
                            >
                        </div>
                        
                        <!-- State Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                            <select 
                                id="dashState" 
                                name="state"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm transition-colors bg-white"
                            >
                                <option value="">Select a state...</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="DC">District of Columbia</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                            </select>
                        </div>
                        
                        <!-- Role Selection (conditional - shown for WA) -->
                        <div id="role-field" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Role</label>
                            <select 
                                id="dashRole" 
                                name="role"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 shadow-sm"
                            >
                                <option value="supplier">Material Supplier</option>
                                <option value="subcontractor">Subcontractor</option>
                                <option value="contractor">General Contractor</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Required for Washington state</p>
                        </div>
                        
                        <!-- Project Type (conditional - shown for TX, OH) -->
                        <div id="project-type-field" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Project Type</label>
                            <select 
                                id="dashProjectType" 
                                name="project_type"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 shadow-sm"
                            >
                                <option value="commercial">Commercial</option>
                                <option value="residential">Residential</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Required for Texas and Ohio</p>
                        </div>
                        
                        <!-- Notice of Completion (conditional - shown for CA) -->
                        <div id="noc-field" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notice of Completion Date (if filed)</label>
                            <input 
                                type="date" 
                                id="dashNOCDate" 
                                name="notice_of_completion_date"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 shadow-sm"
                            >
                            <p class="text-xs text-gray-500 mt-1">Optional - If owner filed Notice of Completion, deadline may shorten</p>
                        </div>
                        
                        <button 
                            type="submit"
                            id="dashCalcBtn"
                            class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5"
                        >
                            Calculate Deadlines
                        </button>
                    </form>
                </div>

                <!-- Hidden Containers for Integration Data (moved here for width) -->
                <div id="qb-invoices" class="hidden bg-white shadow-sm rounded-xl p-6"></div>
                <div id="sage-invoices" class="hidden bg-white shadow-sm rounded-xl p-6"></div>
                <div id="procore-projects" class="hidden bg-white shadow-sm rounded-xl p-6"></div>

                <!-- Calculation Results -->
                <div id="dashResults" class="hidden space-y-6">
                    <div id="dashPrelimCard" class="bg-white shadow-sm rounded-xl p-6 border-l-4">
                        <h3 class="text-xl font-bold mb-4" id="dashPrelimTitle"></h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Deadline</p>
                                <p class="text-2xl font-bold" id="dashPrelimDate"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Days From Now</p>
                                <p class="text-2xl font-bold" id="dashPrelimDays"></p>
                            </div>
                        </div>
                    </div>

                    <div id="dashLienCard" class="bg-white shadow-sm rounded-xl p-6 border-l-4">
                        <h3 class="text-xl font-bold mb-4" id="dashLienTitle"></h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Deadline</p>
                                <p class="text-2xl font-bold" id="dashLienDate"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Days From Now</p>
                                <p class="text-2xl font-bold" id="dashLienDays"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="dashWarnings"></div>
                </div>

                <!-- Save Project Form (Hidden by default) -->
                <div id="save-project-form" class="hidden bg-white shadow-sm rounded-xl p-6 border border-orange-200">
                    <h3 class="text-lg font-bold text-blue-900 mb-1">üíæ Save This Calculation</h3>
                    <p class="text-gray-600 text-sm mb-6">Add project details so you remember what this deadline is for</p>
                    
                    <form id="project-details-form" class="space-y-4">
                        <!-- Required Fields -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">
                                Project Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" 
                                   id="project-name" 
                                   placeholder="e.g., Downtown Office Building" 
                                   required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 shadow-sm">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">
                                Client/Customer Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text" 
                                   id="client-name" 
                                   placeholder="e.g., ABC Construction" 
                                   required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 shadow-sm">
                        </div>

                        <!-- Optional Fields -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">
                                Invoice Amount (Optional)
                            </label>
                            <input type="number" 
                                   id="invoice-amount" 
                                   placeholder="75000" 
                                   step="0.01" 
                                   min="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 shadow-sm">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">
                                Notes (Optional)
                            </label>
                            <textarea id="project-notes" 
                                      rows="3" 
                                      placeholder="e.g., Electrical work on floors 3-5"
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 shadow-sm"></textarea>
                        </div>

                        <!-- Email Reminders Section -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h4 class="text-blue-900 font-semibold mb-3">üìß Email Reminders</h4>
                            
                            <div id="prelim-reminders-section" class="mb-4 pb-4 border-b border-gray-200">
                                <p class="text-sm font-medium text-gray-700 mb-2">Preliminary Notice Deadline:</p>
                                <div class="space-y-2">
                                    <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                        <input type="checkbox" id="prelim-reminder-7" checked class="rounded text-blue-600">
                                        <span>7 days before (<span id="prelim-7-date">calculating...</span>)</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                        <input type="checkbox" id="prelim-reminder-1" class="rounded text-blue-600">
                                        <span>1 day before (<span id="prelim-1-date">calculating...</span>)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="lien-reminders-section">
                                <p class="text-sm font-medium text-gray-700 mb-2">Lien Filing Deadline:</p>
                                <div class="space-y-2">
                                    <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                        <input type="checkbox" id="lien-reminder-7" checked class="rounded text-blue-600">
                                        <span>7 days before (<span id="lien-7-date">calculating...</span>)</span>
                                    </label>
                                    <label class="flex items-center space-x-2 cursor-pointer text-sm">
                                        <input type="checkbox" id="lien-reminder-1" class="rounded text-blue-600">
                                        <span>1 day before (<span id="lien-1-date">calculating...</span>)</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <button type="submit" 
                                id="save-project-btn"
                                class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition-colors shadow-sm">
                            üíæ Save Project & Set Reminders
                        </button>
                    </form>
                </div>
            </div>

            <!-- RIGHT COLUMN (Sidebar) -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- Account Overview -->
                <div id="account-overview" class="bg-white shadow-sm rounded-xl p-6">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">Account Overview</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center pb-3 border-b border-gray-100">
                            <span class="text-gray-600 text-sm">Plan</span>
                            <div class="text-right">
                                <div class="font-semibold text-gray-900">$299/mo</div>
                                <div class="text-xs text-gray-500">Unlimited</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pb-3 border-b border-gray-100">
                            <span class="text-gray-600 text-sm">Status</span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Active
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600 text-sm">Usage</span>
                            <div class="text-right">
                                <div class="font-semibold text-gray-900">1,247</div>
                                <div class="text-xs text-gray-500">API Calls</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Integrations Stack -->
                <div class="space-y-4">
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Integrations</h3>
                    
                    <!-- QuickBooks -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-5" id="quickbooks-section">
                        <div class="flex items-center gap-3 mb-3">
                            <svg class="w-8 h-8 text-blue-600 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 22C6.486 22 2 17.514 2 12S6.486 2 12 2s10 4.486 10 10-4.486 10-10 10z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            <div>
                                <h4 class="font-semibold text-gray-900 text-sm">QuickBooks</h4>
                                <p id="qb-status" class="text-xs text-gray-600">Not connected</p>
                            </div>
                        </div>
                        <button onclick="connectQuickBooks()" id="qb-connect-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 rounded-lg transition-colors">
                            Connect
                        </button>
                    </div>

                    <!-- Sage -->
                    <div class="bg-green-50 border border-green-200 rounded-xl p-5" id="sage-section">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center flex-shrink-0 text-white font-bold text-sm">S</div>
                            <div>
                                <h4 class="font-semibold text-gray-900 text-sm">Sage</h4>
                                <p id="sage-status" class="text-xs text-gray-600">Not connected</p>
                            </div>
                        </div>
                        <button onclick="connectSage()" id="sage-connect-btn" class="w-full bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 rounded-lg transition-colors">
                            Connect
                        </button>
                    </div>

                    <!-- Procore -->
                    <div class="bg-purple-50 border border-purple-200 rounded-xl p-5" id="procore-section">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center flex-shrink-0 text-white font-bold text-sm">P</div>
                            <div>
                                <h4 class="font-semibold text-gray-900 text-sm">Procore</h4>
                                <p id="procore-status" class="text-xs text-gray-600">Not connected</p>
                            </div>
                        </div>
                        <button onclick="connectProcore()" id="procore-connect-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium py-2 rounded-lg transition-colors">
                            Connect
                        </button>
                    </div>
                </div>

                <!-- Usage Stats -->
                <div class="bg-white shadow-sm rounded-xl p-6">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">Top States</h3>
                    <div class="flex flex-wrap gap-2">
                        <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium">TX</span>
                        <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium">CA</span>
                        <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium">FL</span>
                    </div>
                </div>

                <!-- Partner Program -->
                <div class="rounded-xl p-6 relative overflow-hidden text-white" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">
                    <h3 class="font-bold text-lg mb-2">Become a Partner</h3>
                    <p class="text-sm text-orange-50 mb-4">Earn up to $500 per referral.</p>
                    <a href="https://liendeadline.com/partners.html" target="_blank" class="inline-block bg-white text-orange-600 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-gray-50 transition-colors">
                        Join Program ‚Üí
                    </a>
                </div>

                <!-- API Key -->
                <div class="bg-white shadow-sm rounded-xl p-6">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">API Key</h3>
                    <div class="flex gap-2">
                        <input type="text" id="api-key" value="sk_live_..." readonly class="w-full text-xs bg-gray-50 border border-gray-200 rounded px-2 py-1 font-mono text-gray-600">
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button onclick="toggleApiKey()" id="toggle-key-btn" class="flex-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-xs font-medium transition-colors">Reveal</button>
                        <button onclick="copyApiKey()" class="flex-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded text-xs font-medium transition-colors">Copy</button>
                    </div>
                </div>

                <!-- Billing & API Docs Links -->
                <div class="space-y-3">
                    <button onclick="openStripePortal()" class="w-full text-left px-4 py-3 bg-white hover:bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 transition-colors flex justify-between items-center shadow-sm">
                        <span>Billing Portal</span>
                        <span class="text-gray-400">‚Üí</span>
                    </button>
                    <a href="/test-api" class="block w-full text-left px-4 py-3 bg-white hover:bg-gray-50 border border-gray-200 rounded-xl text-sm font-medium text-gray-700 transition-colors flex justify-between items-center shadow-sm">
                        <span>API Documentation</span>
                        <span class="text-gray-400">‚Üí</span>
                    </a>
                </div>

            </div>
        </div>

        <!-- BOTTOM SECTION (History) -->
        <div class="mt-12">
            <div class="bg-white shadow-sm rounded-xl overflow-hidden">
                <div class="p-6 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h2 class="text-xl font-bold text-gray-900">Project History</h2>
                    <div class="flex gap-3">
                        <button onclick="loadCalculationHistory()" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium transition-colors">
                            üîÑ Refresh
                        </button>
                        <button id="exportCSV" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium transition-colors">
                            üìä Export CSV
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="calculation-history" class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600 font-medium border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-4">Project</th>
                                <th class="px-6 py-4">Client</th>
                                <th class="px-6 py-4 text-right">Amount</th>
                                <th class="px-6 py-4 text-center">State</th>
                                <th class="px-6 py-4 text-center">Prelim Deadline</th>
                                <th class="px-6 py-4 text-center">Lien Deadline</th>
                                <th class="px-6 py-4 text-center">Reminders</th>
                                <th class="px-6 py-4 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody" class="divide-y divide-gray-100">
                            <tr>
                                <td colspan="8" class="text-center py-12 text-gray-500">
                                    Loading projects...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Project Details Modal -->
    <div id="project-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg text-gray-900">Project Details</h3>
                <button onclick="closeProjectModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
            </div>
            <div id="project-details-content" class="p-6 overflow-y-auto">
                <!-- Content injected by JS -->
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                <button onclick="deleteProject()" class="text-red-600 hover:text-red-800 font-medium text-sm px-3 py-2">Delete</button>
                <div class="flex-1"></div>
                <button onclick="downloadProjectPDF()" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-medium transition-colors">Download PDF</button>
                <button onclick="editProject()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">Edit Project</button>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT BLOCK -->
    <script>
        // ... Original Script Content ...
        // Re-injecting the massive script block to preserve logic
        
        let currentCalculation = null;

        function showSaveProjectForm(calculationData) {
            currentCalculation = calculationData;
            populateReminderDates();
            const form = document.getElementById('save-project-form');
            form.classList.remove('hidden'); // Tailwind class
            form.style.display = 'block'; // Ensure it shows if style was used
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function getStateNameFromCode(stateCode) {
            const stateMap = {
                'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
                'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
                'DC': 'District of Columbia', 'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii',
                'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
                'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine',
                'MD': 'Maryland', 'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota',
                'MS': 'Mississippi', 'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska',
                'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico',
                'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
                'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island',
                'SC': 'South Carolina', 'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas',
                'UT': 'Utah', 'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington',
                'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
            };
            return stateMap[stateCode] || stateCode;
        }

        function populateReminderDates() {
            if (!currentCalculation) return;
            try {
                const prelim = new Date(currentCalculation.prelimDeadline);
                const lien = new Date(currentCalculation.lienDeadline);
                
                const prelim7 = new Date(prelim); prelim7.setDate(prelim7.getDate() - 7);
                const prelim1 = new Date(prelim); prelim1.setDate(prelim1.getDate() - 1);
                
                const lien7 = new Date(lien); lien7.setDate(lien7.getDate() - 7);
                const lien1 = new Date(lien); lien1.setDate(lien1.getDate() - 1);
                
                document.getElementById('prelim-7-date').textContent = formatDate(prelim7);
                document.getElementById('prelim-1-date').textContent = formatDate(prelim1);
                document.getElementById('lien-7-date').textContent = formatDate(lien7);
                document.getElementById('lien-1-date').textContent = formatDate(lien1);
                
                if (!currentCalculation.prelimDeadline || currentCalculation.prelimDeadline === 'Not Required') {
                    document.getElementById('prelim-reminders-section').style.display = 'none';
                } else {
                    document.getElementById('prelim-reminders-section').style.display = 'block';
                }
            } catch (error) {
                console.error('Error populating reminder dates:', error);
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.textContent = message;
            // Tailwind-like styling for dynamic toast
            toast.style.cssText = `
                position: fixed; bottom: 20px; right: 20px;
                background: ${type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : '#3b82f6'};
                color: white; padding: 12px 24px; border-radius: 8px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                z-index: 10000; font-weight: 500;
                animation: slideInToast 0.3s ease-out;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOutToast 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            const dateInput = document.getElementById('dashInvoiceDate');
            if (dateInput) dateInput.valueAsDate = new Date();
            initStateChangeHandler();
        });

        function getSessionToken() {
            return localStorage.getItem('session_token') || '';
        }

        function initStateChangeHandler() {
            const stateSelect = document.getElementById('dashState');
            if (!stateSelect) return;
            
            stateSelect.addEventListener('change', function(e) {
                const state = e.target.value.toUpperCase();
                
                const roleField = document.getElementById('role-field');
                if (state === 'WA') {
                    roleField.style.display = 'block';
                    document.getElementById('dashRole').required = true;
                } else {
                    roleField.style.display = 'none';
                    document.getElementById('dashRole').required = false;
                }
                
                const projectTypeField = document.getElementById('project-type-field');
                if (state === 'TX' || state === 'OH') {
                    projectTypeField.style.display = 'block';
                    document.getElementById('dashProjectType').required = true;
                } else {
                    projectTypeField.style.display = 'none';
                    document.getElementById('dashProjectType').required = false;
                }
                
                const nocField = document.getElementById('noc-field');
                if (state === 'CA') {
                    nocField.style.display = 'block';
                } else {
                    nocField.style.display = 'none';
                }
            });
        }

        document.getElementById('dashboardCalculatorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const invoiceDate = document.getElementById('dashInvoiceDate').value;
            const state = document.getElementById('dashState').value.toUpperCase();
            
            if (!invoiceDate || !state) {
                alert('Please enter both date and state');
                return;
            }
            
            const submitButton = document.getElementById('dashCalcBtn');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Calculating...';
            submitButton.disabled = true;
            
            try {
                const token = getSessionToken();
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = 'Bearer ' + token;
                
                const formData = {
                    invoice_date: invoiceDate,
                    state: state,
                    role: 'supplier',
                    project_type: 'commercial'
                };
                
                if (state === 'WA') {
                    const role = document.getElementById('dashRole').value;
                    if (role) formData.role = role;
                }
                
                if (state === 'TX' || state === 'OH') {
                    const projectType = document.getElementById('dashProjectType').value;
                    if (projectType) formData.project_type = projectType;
                }
                
                if (state === 'CA') {
                    const nocDate = document.getElementById('dashNOCDate').value;
                    if (nocDate) formData.notice_of_completion_date = nocDate;
                }
                
                const response = await fetch('/api/v1/calculate-deadline', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || errorData.error || `API returned ${response.status}`);
                }
                
                const data = await response.json();
                
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'calculator_submit', { 'event_category': 'Calculator', 'event_label': state, 'value': 1 });
                    gtag('event', 'calculator_used', { event_category: 'engagement', event_label: 'lien_calculator' });
                }
                
                displayDashboardResults(data);
                
                setTimeout(() => {
                    const stateCode = state;
                    const stateName = getStateNameFromCode(stateCode);
                    const prelimDays = data.preliminary_notice?.days_from_now || null;
                    const lienDays = data.lien_filing?.days_from_now || null;
                    
                    showSaveProjectForm({
                        stateName: stateName,
                        stateCode: stateCode,
                        invoiceDate: invoiceDate,
                        prelimDeadline: data.preliminary_notice?.deadline || null,
                        prelimDeadlineDays: prelimDays,
                        lienDeadline: data.lien_filing?.deadline || null,
                        lienDeadlineDays: lienDays
                    });
                }, 300);
                
                saveCalculation(data);
                loadHistory();
                document.getElementById('dashResults').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Calculation error:', error);
                alert('Error calculating deadline: ' + error.message);
            } finally {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            }
        });

        function displayDashboardResults(data) {
            function getUrgency(daysFromNow) {
                if (daysFromNow === null || daysFromNow === undefined) return 'normal';
                if (daysFromNow <= 7) return 'critical';
                if (daysFromNow <= 30) return 'warning';
                return 'normal';
            }
            
            function getUrgencyColor(urgency) {
                if (urgency === 'critical') return 'border-red-500 text-red-700';
                if (urgency === 'warning') return 'border-yellow-500 text-yellow-700';
                return 'border-green-500 text-green-700';
            }
            
            function getUrgencyTextColor(urgency) {
                if (urgency === 'critical') return 'text-red-600';
                if (urgency === 'warning') return 'text-yellow-600';
                return 'text-green-600';
            }
            
            function formatDeadlineDate(dateStr) {
                 if (!dateStr) return 'N/A';
                 return new Date(dateStr).toLocaleDateString();
            }

            const prelimUrgency = data.preliminary_notice.urgency || getUrgency(data.preliminary_notice.days_from_now);
            const lienUrgency = data.lien_filing.urgency || getUrgency(data.lien_filing.days_from_now);
            
            const resultsDiv = document.getElementById('dashResults');
            resultsDiv.classList.remove('hidden');
            
            if (data.preliminary_notice.required) {
                const prelimCard = document.getElementById('dashPrelimCard');
                // Preserve layout classes but update urgency color
                prelimCard.className = `bg-white shadow-sm rounded-xl p-6 border-l-4 ${getUrgencyColor(prelimUrgency)}`;
                
                document.getElementById('dashPrelimTitle').textContent = data.preliminary_notice.name || 'Preliminary Notice Deadline';
                document.getElementById('dashPrelimDate').textContent = data.preliminary_notice.deadline ? formatDeadlineDate(data.preliminary_notice.deadline) : 'Not Required';
                
                const prelimDaysEl = document.getElementById('dashPrelimDays');
                if (data.preliminary_notice.days_from_now !== null) {
                    prelimDaysEl.textContent = `${data.preliminary_notice.days_from_now} days`;
                    prelimDaysEl.className = `text-2xl font-bold ${getUrgencyTextColor(prelimUrgency)}`;
                } else {
                    prelimDaysEl.textContent = 'N/A';
                }
                prelimCard.style.display = 'block';
            } else {
                document.getElementById('dashPrelimCard').style.display = 'none';
            }
            
            const lienCard = document.getElementById('dashLienCard');
            lienCard.className = `bg-white shadow-sm rounded-xl p-6 border-l-4 ${getUrgencyColor(lienUrgency)}`;
            document.getElementById('dashLienTitle').textContent = data.lien_filing.name || 'Lien Filing Deadline';
            document.getElementById('dashLienDate').textContent = data.lien_filing.deadline ? formatDeadlineDate(data.lien_filing.deadline) : 'N/A';
            
            const lienDaysEl = document.getElementById('dashLienDays');
            if (data.lien_filing.days_from_now !== null) {
                lienDaysEl.textContent = `${data.lien_filing.days_from_now} days`;
                lienDaysEl.className = `text-2xl font-bold ${getUrgencyTextColor(lienUrgency)}`;
            } else {
                lienDaysEl.textContent = 'N/A';
            }
            lienCard.style.display = 'block';
            
            if (data.warnings && data.warnings.length > 0) {
                let warningsHtml = '<div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg mt-4"><h4 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Important Notes:</h4><ul class="list-disc list-inside text-yellow-700 space-y-1">';
                data.warnings.forEach(warning => { warningsHtml += `<li>${warning}</li>`; });
                warningsHtml += '</ul></div>';
                
                let warningsDiv = document.getElementById('dashWarnings');
                if (!warningsDiv) {
                    warningsDiv = document.createElement('div');
                    warningsDiv.id = 'dashWarnings';
                    resultsDiv.appendChild(warningsDiv);
                }
                warningsDiv.innerHTML = warningsHtml;
            }
        }

        function saveCalculation(data) {
            let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
            const calculation = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                invoice_date: data.invoice_date,
                state: data.state_code || data.state,
                state_name: data.state_name || data.state,
                prelim_deadline: data.preliminary_notice?.deadline || null,
                lien_deadline: data.lien_filing?.deadline || null,
                prelim_days: data.preliminary_notice?.days_from_now || null,
                lien_days: data.lien_filing?.days_from_now || null,
                warnings: data.warnings || [],
                data: data
            };
            history.unshift(calculation);
            if (history.length > 100) history = history.slice(0, 100);
            localStorage.setItem('calculationHistory', JSON.stringify(history));
        }
        
        // Legacy loadHistory function for local storage fallback
        function loadHistory() {
             loadCalculationHistory(); // Prefer API
        }

        async function loadCalculationHistory() {
            try {
                const token = getSessionToken();
                const headers = {};
                if (token) headers['Authorization'] = 'Bearer ' + token;
                
                const response = await fetch('/api/calculations/history', { headers: headers });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const tbody = document.getElementById('history-tbody');
                
                window.loadedCalculations = data.calculations || [];
                
                if (!data.success || !data.calculations || data.calculations.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="8" class="text-center py-12 text-gray-500">No projects yet. Calculate a deadline above to get started!</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = data.calculations.map(calc => {
                    const amount = calc.invoiceAmount ? `$${calc.invoiceAmount.toLocaleString()}` : '-';
                    // Re-implement formatDeadlineDate logic here or reuse helper? 
                    // reusing logic inline for safety as helper was outside scope in original read
                     const formatDateStr = (d) => d ? new Date(d).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) : 'Not Required';
                    const prelimDate = formatDateStr(calc.prelimDeadline);
                    const lienDate = formatDateStr(calc.lienDeadline);
                    
                    return `
                        <tr class="hover:bg-gray-50 transition-colors border-b border-gray-100">
                            <td class="px-6 py-4">
                                <div class="font-medium text-gray-900">${escapeHtml(calc.projectName)}</div>
                                ${calc.notes ? `<div class="text-xs text-gray-500 truncate max-w-xs">${escapeHtml(calc.notes)}</div>` : ''}
                            </td>
                            <td class="px-6 py-4">${escapeHtml(calc.clientName)}</td>
                            <td class="px-6 py-4 text-right font-mono text-xs">${amount}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${calc.state}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center text-xs">${prelimDate}</td>
                            <td class="px-6 py-4 text-center text-xs font-medium text-orange-600">${lienDate}</td>
                            <td class="px-6 py-4 text-center">
                                ${calc.activeReminders > 0 ? 
                                    `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        üìß ${calc.activeReminders} active
                                    </span>` : 
                                    `<span class="text-gray-400 text-xs">None</span>`
                                }
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button onclick="downloadProjectPDF('${calc.id}')" class="text-orange-600 hover:text-orange-800 text-xs font-bold">PDF</button>
                                    <button onclick="viewProject('${calc.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-bold">View</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading calculation history:', error);
                document.getElementById('history-tbody').innerHTML = `<tr><td colspan="8" class="text-center py-12 text-red-500">Error loading projects.</td></tr>`;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Project Management Functions (View, Edit, Delete, PDF)
        let currentProject = null;
        
        function viewProject(calculationId) {
            const id = parseInt(calculationId, 10);
            const project = window.loadedCalculations?.find(c => c.id === id);
            if (!project) { alert('Project not found'); return; }
            currentProject = project;
            
            const detailsHtml = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase">Project Name</label>
                            <div class="mt-1 text-sm font-medium text-gray-900">${escapeHtml(project.projectName || 'N/A')}</div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase">Client</label>
                            <div class="mt-1 text-sm font-medium text-gray-900">${escapeHtml(project.clientName || 'N/A')}</div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <div class="flex justify-between items-center">
                            <div>
                                <label class="block text-xs font-bold text-blue-600 uppercase">Amount</label>
                                <div class="mt-1 text-lg font-bold text-blue-900">$${parseFloat(project.invoiceAmount || 0).toLocaleString()}</div>
                            </div>
                            <div class="text-right">
                                <label class="block text-xs font-bold text-blue-600 uppercase">State</label>
                                <div class="mt-1 text-lg font-bold text-blue-900">${project.state}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                         <div class="bg-green-50 p-3 rounded border border-green-200">
                            <label class="block text-xs font-bold text-green-700">Prelim Deadline</label>
                            <div class="font-bold text-green-900">${project.prelimDeadline ? new Date(project.prelimDeadline).toLocaleDateString() : 'Not Required'}</div>
                         </div>
                         <div class="bg-orange-50 p-3 rounded border border-orange-200">
                            <label class="block text-xs font-bold text-orange-700">Lien Deadline</label>
                            <div class="font-bold text-orange-900">${project.lienDeadline ? new Date(project.lienDeadline).toLocaleDateString() : 'N/A'}</div>
                         </div>
                    </div>

                    ${project.notes ? `
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase">Notes</label>
                            <div class="mt-1 text-sm text-gray-700 bg-gray-50 p-3 rounded border border-gray-200">${escapeHtml(project.notes)}</div>
                        </div>
                    ` : ''}
                    
                    <div class="text-xs text-center text-gray-400 pt-2">Created: ${new Date(project.createdAt).toLocaleString()}</div>
                </div>
            `;
            
            document.getElementById('project-details-content').innerHTML = detailsHtml;
            document.getElementById('project-details-modal').style.display = 'flex';
        }

        function closeProjectModal() {
            document.getElementById('project-details-modal').style.display = 'none';
            currentProject = null;
        }

        function downloadProjectPDF(calcId) {
             const id = calcId || (currentProject ? currentProject.id : null);
             if(!id) return;
             
             // Logic to redirect to PDF endpoint
             // For now, using the logic from original file:
             const project = window.loadedCalculations?.find(c => c.id == id) || currentProject;
             if(project) {
                 const stateCode = project.stateCode || 'UNKNOWN';
                 const dateStr = new Date(project.invoiceDate).toISOString().split('T')[0];
                 const url = `/api/v1/guide/${stateCode}/pdf?invoice_date=${dateStr}&state_name=${encodeURIComponent(project.state)}`;
                 window.open(url, '_blank');
             }
        }

        function editProject() {
            if (!currentProject) return;
            closeProjectModal();
            const dateInput = document.getElementById('dashInvoiceDate');
            const stateSelect = document.getElementById('dashState');
            
            if (dateInput && currentProject.invoiceDate) {
                dateInput.value = new Date(currentProject.invoiceDate).toISOString().split('T')[0];
            }
            if (stateSelect && currentProject.stateCode) {
                stateSelect.value = currentProject.stateCode;
                stateSelect.dispatchEvent(new Event('change'));
            }
            
            document.getElementById('calculator').scrollIntoView({ behavior: 'smooth', block: 'start' });
            setTimeout(() => {
                alert(`Editing: ${currentProject.projectName}. Recalculate and save to update.`);
            }, 500);
        }

        async function deleteProject() {
            if (!currentProject) return;
            if (!confirm(`Delete "${currentProject.projectName}"?`)) return;
            
            try {
                const token = getSessionToken();
                const response = await fetch(`/api/calculations/${currentProject.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    closeProjectModal();
                    loadHistory();
                    showToast('Project deleted', 'success');
                } else {
                    alert('Failed to delete');
                }
            } catch (error) {
                console.error(error);
                alert('Error deleting project');
            }
        }

        // Project details save handler
        document.getElementById('project-details-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentCalculation) {
                alert('No active calculation to save');
                return;
            }
            
            const submitBtn = document.getElementById('save-project-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;
            
            try {
                const token = getSessionToken();
                
                // Get reminders
                const reminders = [];
                if (document.getElementById('prelim-reminder-7').checked) reminders.push('prelim_7');
                if (document.getElementById('prelim-reminder-1').checked) reminders.push('prelim_1');
                if (document.getElementById('lien-reminder-7').checked) reminders.push('lien_7');
                if (document.getElementById('lien-reminder-1').checked) reminders.push('lien_1');
                
                const payload = {
                    project_name: document.getElementById('project-name').value,
                    client_name: document.getElementById('client-name').value,
                    invoice_amount: document.getElementById('invoice-amount').value || 0,
                    notes: document.getElementById('project-notes').value || '',
                    calculation_data: currentCalculation,
                    reminders: reminders,
                    // Flatten key fields for DB
                    state_code: currentCalculation.state_code || currentCalculation.state,
                    state_name: currentCalculation.state_name || currentCalculation.state,
                    invoice_date: currentCalculation.invoice_date,
                    prelim_deadline: currentCalculation.preliminary_notice?.deadline,
                    lien_deadline: currentCalculation.lien_filing?.deadline
                };
                
                const response = await fetch('/api/calculations/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast('‚úÖ Project saved successfully!', 'success');
                    document.getElementById('save-project-form').classList.add('hidden');
                    document.getElementById('save-project-form').style.display = 'none';
                    document.getElementById('project-details-form').reset();
                    loadHistory();
                } else {
                    showToast('‚ùå Error: ' + (result.error || 'Failed to save'), 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showToast('‚ùå Network error', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // API Key & Integrations Logic
        let apiKeyVisible = false;
        let fullApiKey = '';

        window.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('api-key');
            if (input) {
                fullApiKey = input.value;
                maskApiKey();
            }
            checkQuickBooksStatus();
        });

        function maskApiKey() {
            const input = document.getElementById('api-key');
            const btn = document.getElementById('toggle-key-btn');
            if (fullApiKey) {
                const prefix = fullApiKey.substring(0, 12);
                const suffix = fullApiKey.substring(fullApiKey.length - 4);
                input.value = prefix + '‚Ä¶' + suffix;
                btn.textContent = 'Reveal';
                apiKeyVisible = false;
            }
        }

        function toggleApiKey() {
            const input = document.getElementById('api-key');
            const btn = document.getElementById('toggle-key-btn');
            if (apiKeyVisible) {
                maskApiKey();
            } else {
                input.value = fullApiKey;
                btn.textContent = 'Hide';
                apiKeyVisible = true;
            }
        }

        function copyApiKey() {
            navigator.clipboard.writeText(fullApiKey).then(() => showToast('API Key Copied', 'success'));
        }

        // Integration Functions (Mocked or Real)
        function connectQuickBooks() { window.location.href = '/api/quickbooks/connect'; }
        function connectSage() { alert('Sage integration coming soon!'); }
        function connectProcore() { alert('Procore integration coming soon!'); }
        
        async function checkQuickBooksStatus() {
            // Logic to check QB status
            // (Reusing original logic structure)
             const token = localStorage.getItem('session_token');
             if (!token) return;
             try {
                const response = await fetch('/api/quickbooks/status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.connected) {
                        document.getElementById('qb-status').textContent = 'Connected ‚úì';
                        document.getElementById('qb-status').className = 'text-xs text-green-600 font-bold';
                        document.getElementById('qb-connect-btn').textContent = 'Manage';
                    }
                }
             } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>
