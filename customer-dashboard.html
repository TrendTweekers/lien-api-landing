<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deadline Dashboard - LienDeadline.com</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KYZG0TN07Z"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KYZG0TN07Z');
    </script>
    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="02250d35-ee17-41be-845d-2fe0f7f15e63"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÖ</text></svg>">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <!-- Lovable Scale Stylesheet (load first) -->
    <link rel="stylesheet" href="/lovable-scale.css">
    <style>
        /* CSS Variables for consistent theming */
        :root {
            --navy: hsl(220 60% 20%);
            --coral: #f97316;
            --coral-dark: #ea580c;
            --coral-light: #fb923c;
        }

        /* Beautiful visual design */
        .dashboard-container {
            background: linear-gradient(135deg, var(--navy), var(--coral));
            min-height: 100vh;
            padding: 2rem 0;
        }

        /* Beautiful calculator section */
        #calculator {
            margin: 2rem 0;
        }

        #calculator > div {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        #calculator > div:hover {
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        /* Beautiful heading */
        #calculator h2 {
            font-family: 'Instrument Serif', serif;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--navy), var(--coral));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        /* Beautiful date input */
        #dash_invoice_date {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--coral);
            border-radius: 12px;
            font-size: 1.1rem;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #dash_invoice_date:hover {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        #dash_invoice_date:focus {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
            outline: none;
        }

        /* Beautiful state select */
        #dash_state {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--coral);
            border-radius: 12px;
            font-size: 1.1rem;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #dash_state:hover {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        #dash_state:focus {
            border-color: var(--coral-dark);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
            outline: none;
        }

        /* Beautiful button */
        #dash_calc_btn {
            background: linear-gradient(135deg, var(--coral), var(--coral-dark));
            border: none;
            border-radius: 50px;
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }

        #dash_calc_btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(249, 115, 22, 0.4);
            background: linear-gradient(135deg, var(--coral-dark), var(--coral));
        }

        #dash_calc_btn:active:not(:disabled) {
            transform: translateY(0);
        }

        #dash_calc_btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Beautiful results */
        #dash_results {
            margin-top: 3rem;
        }

        #dash_results > div {
            transition: all 0.3s ease;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .result-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-4px);
        }

        /* Beautiful error messages */
        #dash_calc_error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            color: #dc2626;
            font-weight: 500;
        }

        /* Beautiful PDF button */
        #dash_pdf_btn {
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 12px;
            padding: 1rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        #dash_pdf_btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669, #10b981);
        }

        /* Beautiful labels */
        #dash_calc_form label {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 0.5rem;
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            #calculator > div {
                padding: 2rem 1.5rem;
                margin: 1rem;
                border-radius: 16px;
            }

            #calculator h2 {
                font-size: 2rem;
            }

            #dash_calc_btn {
                width: 100%;
                padding: 1rem;
                font-size: 1.1rem;
            }

            #dash_invoice_date,
            #dash_state {
                padding: 0.875rem;
                font-size: 1rem;
            }

            .result-card {
                padding: 1.5rem;
            }
        }

        /* Loading animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* Beautiful focus states */
        .focus-ring:focus {
            outline: none;
            ring: 2px;
            ring-color: var(--coral);
            ring-opacity: 0.5;
        }

        /* Enhanced result cards */
        #dash_prelim_card,
        #dash_lien_card {
            position: relative;
            overflow: hidden;
        }

        #dash_prelim_card::before,
        #dash_lien_card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--coral);
            transition: width 0.3s ease;
        }

        #dash_prelim_card:hover::before,
        #dash_lien_card:hover::before {
            width: 6px;
        }

        /* Beautiful serving requirements */
        #dash_serving_list li {
            transition: all 0.2s ease;
        }

        #dash_serving_list li:hover {
            transform: translateX(4px);
            color: var(--coral-dark);
        }

        /* Beautiful warnings section */
        #dash_warnings_section {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInToast {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutToast {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    
      /* Force logo size - override all parent constraints */
      header a[href="/"] img[alt="LienDeadline"],
      header a[href="/admin-dashboard"] img[alt="LienDeadline"],
      header a[href="/broker-dashboard"] img[alt="LienDeadline"],
      header img[alt="LienDeadline"],
      nav img[alt="LienDeadline"],
      header a img[alt="LienDeadline"] {
        height: 56px !important;
        width: auto !important;
        min-height: 56px !important;
        max-height: 56px !important;
        display: block !important;
        object-fit: contain !important;
        flex-shrink: 0 !important;
      }
      
      /* Ensure parent <a> doesn't constrain logo */
      header a[href="/"],
      header a[href="/admin-dashboard"],
      header a[href="/broker-dashboard"],
      nav a[href="/"] {
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        display: flex !important;
        align-items: center !important;
        flex-shrink: 0 !important;
      }
      
      /* Override any Tailwind or framework classes */
      header .h-6,
      header .h-8,
      header .h-10,
      header .h-12 {
        height: auto !important;
      }
      
      @media (max-width: 768px) {
        header a[href="/"] img[alt="LienDeadline"],
        header a[href="/admin-dashboard"] img[alt="LienDeadline"],
        header a[href="/broker-dashboard"] img[alt="LienDeadline"],
        header img[alt="LienDeadline"],
        nav img[alt="LienDeadline"],
        header a img[alt="LienDeadline"] {
          height: 44px !important;
          min-height: 44px !important;
          max-height: 44px !important;
          width: auto !important;
        }
      }
      

    </style>
    <script>
        // Check authentication on page load
        async function checkAuth() {
            const token = localStorage.getItem('session_token');
            
            if (!token) {
                window.location.href = '/dashboard';
                return;
            }
            
            try {
                const response = await fetch('/api/verify-session', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    // Session invalid - redirect to login
                    localStorage.removeItem('session_token');
                    localStorage.removeItem('user_email');
                    window.location.href = '/dashboard';
                    return;
                }
                
                const data = await response.json();
                
                // Display user email
                const userEmailEl = document.getElementById('user-email');
                if (userEmailEl) {
                    userEmailEl.textContent = data.email;
                }
                
                // Check subscription status
                if (data.subscription_status === 'cancelled') {
                    // Show subscription warning (you can add UI for this)
                    console.warn('Subscription cancelled');
                }
                
            } catch (err) {
                console.error('Auth check failed:', err);
                window.location.href = '/dashboard';
            }
        }
        
        // Logout function
        function logout() {
            const token = localStorage.getItem('session_token');
            
            fetch('/api/logout', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            }).finally(() => {
                localStorage.removeItem('session_token');
                localStorage.removeItem('user_email');
                window.location.href = '/dashboard';
            });
        }
        
        // Run on page load
        window.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <header style="background: white; border-bottom: 1px solid #E5E7EB; padding: 16px 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <a href="/" style="text-decoration: none;">
                <img src="/images/liendeadline-logo.png" alt="LienDeadline" style="height: 56px !important; width: auto !important; min-height: 56px !important; max-height: 56px !important; display: block;">
            </a>
            
            <div class="flex gap-4 items-center">
                <a href="#calculator" onclick="scrollToCalculator(event)" class="text-gray-600 hover:text-gray-900">Calculator</a>
                <span id="user-email" class="text-sm text-gray-600"></span>
                <a href="index.html" class="text-gray-600 hover:text-gray-900">Landing Page</a>
                <button onclick="logout()" class="text-red-600 hover:text-red-700">Logout</button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Integrations Section - 3 Column Grid -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Accounting Integrations</h2>
            
            <!-- BETA BANNER -->
            <div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 12px 16px; border-radius: 8px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                <div>
                    <strong style="color: #92400e;">Beta Feature</strong>
                    <p style="margin: 4px 0 0 0; color: #78350f; font-size: 14px;">
                        Integrations are currently in beta testing. For now, we recommend manually entering invoice dates into the calculator above.
                    </p>
                </div>
            </div>
            
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- QuickBooks Integration Card -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6" id="quickbooks-section">
                    <div class="flex flex-col h-full">
                        <div class="flex items-start gap-4 mb-4">
                            <svg class="w-12 h-12 text-blue-600 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 22C6.486 22 2 17.514 2 12S6.486 2 12 2s10 4.486 10 10-4.486 10-10 10z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900 mb-1">QuickBooks Integration</h3>
                                <p class="text-sm text-gray-600">Import invoices and auto-calculate lien deadlines</p>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <div class="flex items-center justify-between mb-4">
                                <span id="qb-status" class="text-sm text-gray-600">Not connected</span>
                            </div>
                            <button 
                                onclick="connectQuickBooks()"
                                id="qb-connect-btn"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
                            >
                                Connect QuickBooks
                            </button>
                            <a 
                                href="#" 
                                onclick="reportIntegrationIssue('QuickBooks'); return false;"
                                class="block text-center text-xs text-gray-500 hover:text-gray-700 mt-2 underline"
                            >
                                Report Issue
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Sage Integration Card -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-6" id="sage-section">
                    <div class="flex flex-col h-full">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <span class="text-white text-2xl font-bold">S</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900 mb-1">Sage Integration</h3>
                                <p class="text-sm text-gray-600">Import invoices from Sage accounting</p>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <div class="flex items-center justify-between mb-4">
                                <span id="sage-status" class="text-sm text-gray-600">Not connected</span>
                            </div>
                            <button 
                                onclick="connectSage()"
                                id="sage-connect-btn"
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
                            >
                                Connect Sage
                            </button>
                            <a 
                                href="#" 
                                onclick="reportIntegrationIssue('Sage'); return false;"
                                class="block text-center text-xs text-gray-500 hover:text-gray-700 mt-2 underline"
                            >
                                Report Issue
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Procore Integration Card -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-6" id="procore-section">
                    <div class="flex flex-col h-full">
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                <span class="text-white text-2xl font-bold">P</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900 mb-1">Procore Integration</h3>
                                <p class="text-sm text-gray-600">Import projects and calculate lien deadlines</p>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <div class="flex items-center justify-between mb-4">
                                <span id="procore-status" class="text-sm text-gray-600">Not connected</span>
                            </div>
                            <button 
                                onclick="connectProcore()"
                                id="procore-connect-btn"
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
                            >
                                Connect Procore
                            </button>
                            <a 
                                href="#" 
                                onclick="reportIntegrationIssue('Procore'); return false;"
                                class="block text-center text-xs text-gray-500 hover:text-gray-700 mt-2 underline"
                            >
                                Report Issue
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Lists (shown after connection) -->
            <div id="qb-invoices" class="mt-6 hidden">
                <!-- QuickBooks invoice list will appear here after connection -->
            </div>
            <div id="sage-invoices" class="mt-6 hidden">
                <!-- Sage invoice list will appear here after connection -->
            </div>
            <div id="procore-projects" class="mt-6 hidden">
                <!-- Procore projects list will appear here after connection -->
            </div>
        </div>

        <!-- Account Overview -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">Account Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <div class="text-sm text-gray-600 mb-1">Plan</div>
                    <div class="text-xl font-semibold text-gray-900">$299/month</div>
                    <div class="text-sm text-gray-500">Unlimited API calls</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-1">Status</div>
                    <div class="text-xl font-semibold text-green-600">Active</div>
                    <div class="text-sm text-gray-500">Next billing: Dec 23, 2025</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-1">API Calls This Month</div>
                    <div class="text-xl font-semibold text-gray-900">1,247</div>
                    <div class="text-sm text-gray-500">Unlimited plan</div>
                </div>
            </div>
        </div>

        <!-- Calculator Section (Updated to match working homepage calculator) -->
        <div class="bg-white shadow-lg rounded-lg p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6">Calculate New Deadline</h2>
            
            <form id="dashboardCalculatorForm" class="space-y-4">
                <!-- Invoice Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Invoice/Delivery Date</label>
                    <input 
                        type="date" 
                        id="dashInvoiceDate" 
                        name="invoice_date"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>
                
                <!-- State Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                    <select 
                        id="dashState" 
                        name="state"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                        <option value="">Select a state...</option>
                        <option value="AL">Alabama</option>
                        <option value="AK">Alaska</option>
                        <option value="AZ">Arizona</option>
                        <option value="AR">Arkansas</option>
                        <option value="CA">California</option>
                        <option value="CO">Colorado</option>
                        <option value="CT">Connecticut</option>
                        <option value="DE">Delaware</option>
                        <option value="DC">District of Columbia</option>
                        <option value="FL">Florida</option>
                        <option value="GA">Georgia</option>
                        <option value="HI">Hawaii</option>
                        <option value="ID">Idaho</option>
                        <option value="IL">Illinois</option>
                        <option value="IN">Indiana</option>
                        <option value="IA">Iowa</option>
                        <option value="KS">Kansas</option>
                        <option value="KY">Kentucky</option>
                        <option value="LA">Louisiana</option>
                        <option value="ME">Maine</option>
                        <option value="MD">Maryland</option>
                        <option value="MA">Massachusetts</option>
                        <option value="MI">Michigan</option>
                        <option value="MN">Minnesota</option>
                        <option value="MS">Mississippi</option>
                        <option value="MO">Missouri</option>
                        <option value="MT">Montana</option>
                        <option value="NE">Nebraska</option>
                        <option value="NV">Nevada</option>
                        <option value="NH">New Hampshire</option>
                        <option value="NJ">New Jersey</option>
                        <option value="NM">New Mexico</option>
                        <option value="NY">New York</option>
                        <option value="NC">North Carolina</option>
                        <option value="ND">North Dakota</option>
                        <option value="OH">Ohio</option>
                        <option value="OK">Oklahoma</option>
                        <option value="OR">Oregon</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="RI">Rhode Island</option>
                        <option value="SC">South Carolina</option>
                        <option value="SD">South Dakota</option>
                        <option value="TN">Tennessee</option>
                        <option value="TX">Texas</option>
                        <option value="UT">Utah</option>
                        <option value="VT">Vermont</option>
                        <option value="VA">Virginia</option>
                        <option value="WA">Washington</option>
                        <option value="WV">West Virginia</option>
                        <option value="WI">Wisconsin</option>
                        <option value="WY">Wyoming</option>
                    </select>
                </div>
                
                <!-- Role Selection (conditional - shown for WA) -->
                <div id="role-field" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Your Role</label>
                    <select 
                        id="dashRole" 
                        name="role"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="supplier">Material Supplier</option>
                        <option value="subcontractor">Subcontractor</option>
                        <option value="contractor">General Contractor</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Required for Washington state</p>
                </div>
                
                <!-- Project Type (conditional - shown for TX, OH) -->
                <div id="project-type-field" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Project Type</label>
                    <select 
                        id="dashProjectType" 
                        name="project_type"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="commercial">Commercial</option>
                        <option value="residential">Residential</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Required for Texas and Ohio</p>
                </div>
                
                <!-- Notice of Completion (conditional - shown for CA) -->
                <div id="noc-field" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notice of Completion Date (if filed)</label>
                    <input 
                        type="date" 
                        id="dashNOCDate" 
                        name="notice_of_completion_date"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    >
                    <p class="text-xs text-gray-500 mt-1">Optional - If owner filed Notice of Completion, deadline may shorten</p>
                </div>
                
                <button 
                    type="submit"
                    id="dashCalcBtn"
                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors"
                >
                    Calculate Deadlines
                </button>
            </form>
        </div>

        <!-- Calculation Results -->
        <div id="dashResults" class="hidden space-y-6 mb-8">
            <div id="dashPrelimCard" class="bg-white shadow-lg rounded-lg p-6 border-l-4">
                <h3 class="text-xl font-bold mb-4" id="dashPrelimTitle"></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Deadline</p>
                        <p class="text-2xl font-bold" id="dashPrelimDate"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Days From Now</p>
                        <p class="text-2xl font-bold" id="dashPrelimDays"></p>
                    </div>
                </div>
            </div>

            <div id="dashLienCard" class="bg-white shadow-lg rounded-lg p-6 border-l-4">
                <h3 class="text-xl font-bold mb-4" id="dashLienTitle"></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Deadline</p>
                        <p class="text-2xl font-bold" id="dashLienDate"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Days From Now</p>
                        <p class="text-2xl font-bold" id="dashLienDays"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Details Form (Hidden by default) -->
        <div id="save-project-form" style="display:none; background:#f8f9fa; padding:25px; margin:30px 0; border-radius:8px; border:2px solid #f97316; max-width:800px;">
            <h3 style="color:#1e3a8a; margin-bottom:5px;">üíæ Save This Calculation</h3>
            <p style="color:#666; margin-bottom:20px; font-size:14px;">Add project details so you remember what this deadline is for</p>
            
            <form id="project-details-form">
                <!-- Required Fields -->
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:5px; font-size:14px;">
                        Project Name <span style="color:red;">*</span>
                    </label>
                    <input type="text" 
                           id="project-name" 
                           placeholder="e.g., Downtown Office Building" 
                           required
                           style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:14px; box-sizing:border-box;">
                    <small style="color:#666; font-size:12px;">Give this project a memorable name</small>
                </div>

                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:5px; font-size:14px;">
                        Client/Customer Name <span style="color:red;">*</span>
                    </label>
                    <input type="text" 
                           id="client-name" 
                           placeholder="e.g., ABC Construction" 
                           required
                           style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:14px; box-sizing:border-box;">
                </div>

                <!-- Optional Fields -->
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:600; margin-bottom:5px; font-size:14px;">
                        Invoice Amount (Optional)
                    </label>
                    <input type="number" 
                           id="invoice-amount" 
                           placeholder="75000" 
                           step="0.01" 
                           min="0"
                           style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:14px; box-sizing:border-box;">
                    <small style="color:#666; font-size:12px;">Helps you prioritize high-value projects</small>
                </div>

                <div style="margin-bottom:20px;">
                    <label style="display:block; font-weight:600; margin-bottom:5px; font-size:14px;">
                        Notes (Optional)
                    </label>
                    <textarea id="project-notes" 
                              rows="3" 
                              placeholder="e.g., Electrical work on floors 3-5"
                              style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px; font-size:14px; resize:vertical; box-sizing:border-box;"></textarea>
                </div>

                <!-- Email Reminders Section -->
                <div style="background:white; padding:15px; border-radius:5px; margin-bottom:20px; border:1px solid #e0e0e0;">
                    <h4 style="margin:0 0 15px 0; color:#1e3a8a; font-size:16px;">üìß Email Reminders</h4>
                    
                    <div id="prelim-reminders-section" style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
                        <p style="margin:0 0 10px 0; font-weight:600; font-size:14px;">Preliminary Notice Deadline:</p>
                        <label style="display:block; margin-bottom:8px; cursor:pointer; font-size:14px;">
                            <input type="checkbox" id="prelim-reminder-7" checked>
                            <span style="margin-left:8px;">7 days before (<span id="prelim-7-date">calculating...</span>)</span>
                        </label>
                        <label style="display:block; cursor:pointer; font-size:14px;">
                            <input type="checkbox" id="prelim-reminder-1">
                            <span style="margin-left:8px;">1 day before (<span id="prelim-1-date">calculating...</span>)</span>
                        </label>
                    </div>
                    
                    <div id="lien-reminders-section">
                        <p style="margin:0 0 10px 0; font-weight:600; font-size:14px;">Lien Filing Deadline:</p>
                        <label style="display:block; margin-bottom:8px; cursor:pointer; font-size:14px;">
                            <input type="checkbox" id="lien-reminder-7" checked>
                            <span style="margin-left:8px;">7 days before (<span id="lien-7-date">calculating...</span>)</span>
                        </label>
                        <label style="display:block; cursor:pointer; font-size:14px;">
                            <input type="checkbox" id="lien-reminder-1">
                            <span style="margin-left:8px;">1 day before (<span id="lien-1-date">calculating...</span>)</span>
                        </label>
                    </div>
                </div>

                <button type="submit" 
                        id="save-project-btn"
                        style="background:#f97316; color:white; padding:12px 30px; border:none; border-radius:5px; cursor:pointer; font-size:16px; font-weight:600; width:100%;">
                    üíæ Save Project & Set Reminders
                </button>
            </form>
        </div>

        <!-- Calculation History -->
        <div class="calculation-history-section" style="margin-top:40px;">
            <div class="bg-white shadow-lg rounded-lg p-8">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 class="text-2xl font-bold">Your Projects</h2>
                    <div style="display:flex; gap:10px;">
                        <button onclick="loadCalculationHistory()" style="background:#3b82f6; color:white; padding:8px 16px; border:none; border-radius:5px; cursor:pointer;">
                            üîÑ Refresh
                        </button>
                        <button id="exportCSV" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            üìä Export to CSV
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="calculation-history" style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="background:#1e3a8a; color:white;">
                                <th style="padding:12px; text-align:left;">Project</th>
                                <th style="padding:12px; text-align:left;">Client</th>
                                <th style="padding:12px; text-align:right;">Amount</th>
                                <th style="padding:12px; text-align:center;">State</th>
                                <th style="padding:12px; text-align:center;">Prelim Deadline</th>
                                <th style="padding:12px; text-align:center;">Lien Deadline</th>
                                <th style="padding:12px; text-align:center;">Reminders</th>
                                <th style="padding:12px; text-align:center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-tbody">
                            <tr>
                                <td colspan="8" style="text-align:center; padding:40px; color:#666;">
                                    Loading projects...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // Global variable to store current calculation
            let currentCalculation = null;

            // Show the save form after calculation
            function showSaveProjectForm(calculationData) {
                currentCalculation = calculationData;
                
                // Populate reminder dates
                populateReminderDates();
                
                // Show the form
                document.getElementById('save-project-form').style.display = 'block';
                
                // Scroll to form
                document.getElementById('save-project-form').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }

            // Helper function to get state name from code
            function getStateNameFromCode(stateCode) {
                const stateMap = {
                    'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas',
                    'CA': 'California', 'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware',
                    'DC': 'District of Columbia', 'FL': 'Florida', 'GA': 'Georgia', 'HI': 'Hawaii',
                    'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
                    'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine',
                    'MD': 'Maryland', 'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota',
                    'MS': 'Mississippi', 'MO': 'Missouri', 'MT': 'Montana', 'NE': 'Nebraska',
                    'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey', 'NM': 'New Mexico',
                    'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
                    'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island',
                    'SC': 'South Carolina', 'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas',
                    'UT': 'Utah', 'VT': 'Vermont', 'VA': 'Virginia', 'WA': 'Washington',
                    'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
                };
                return stateMap[stateCode] || stateCode;
            }

            // Populate reminder date labels
            function populateReminderDates() {
                if (!currentCalculation) return;
                
                try {
                    const prelim = new Date(currentCalculation.prelimDeadline);
                    const lien = new Date(currentCalculation.lienDeadline);
                    
                    // Calculate reminder dates
                    const prelim7 = new Date(prelim);
                    prelim7.setDate(prelim7.getDate() - 7);
                    
                    const prelim1 = new Date(prelim);
                    prelim1.setDate(prelim1.getDate() - 1);
                    
                    const lien7 = new Date(lien);
                    lien7.setDate(lien7.getDate() - 7);
                    
                    const lien1 = new Date(lien);
                    lien1.setDate(lien1.getDate() - 1);
                    
                    // Format and display
                    document.getElementById('prelim-7-date').textContent = formatDate(prelim7);
                    document.getElementById('prelim-1-date').textContent = formatDate(prelim1);
                    document.getElementById('lien-7-date').textContent = formatDate(lien7);
                    document.getElementById('lien-1-date').textContent = formatDate(lien1);
                    
                    // Hide prelim section if not required
                    if (!currentCalculation.prelimDeadline || currentCalculation.prelimDeadline === 'Not Required') {
                        document.getElementById('prelim-reminders-section').style.display = 'none';
                    } else {
                        document.getElementById('prelim-reminders-section').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error populating reminder dates:', error);
                }
            }

            // Toast notification function
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#16a34a' : type === 'error' ? '#dc2626' : '#3b82f6'};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-size: 14px;
                    max-width: 400px;
                    animation: slideIn 0.3s ease-out;
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }

            // Helper to format dates
            function formatDate(date) {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
            }

            // Ported from dashboard.js with Authorization Bearer token support
            document.addEventListener('DOMContentLoaded', () => {
                loadHistory();
                
                // Set default date
                const dateInput = document.getElementById('dashInvoiceDate');
                if (dateInput) {
                    dateInput.valueAsDate = new Date();
                }
                
                // Initialize state change handler for conditional fields
                initStateChangeHandler();
            });

            // Get session token helper
            function getSessionToken() {
                return localStorage.getItem('session_token') || '';
            }

            // State change handler - show/hide conditional fields
            function initStateChangeHandler() {
                const stateSelect = document.getElementById('dashState');
                if (!stateSelect) return;
                
                stateSelect.addEventListener('change', function(e) {
                    const state = e.target.value.toUpperCase();
                    
                    // Show role field for Washington
                    const roleField = document.getElementById('role-field');
                    if (state === 'WA') {
                        roleField.style.display = 'block';
                        document.getElementById('dashRole').required = true;
                    } else {
                        roleField.style.display = 'none';
                        document.getElementById('dashRole').required = false;
                    }
                    
                    // Show project type for Texas, Ohio
                    const projectTypeField = document.getElementById('project-type-field');
                    if (state === 'TX' || state === 'OH') {
                        projectTypeField.style.display = 'block';
                        document.getElementById('dashProjectType').required = true;
                    } else {
                        projectTypeField.style.display = 'none';
                        document.getElementById('dashProjectType').required = false;
                    }
                    
                    // Show NOC field for California
                    const nocField = document.getElementById('noc-field');
                    if (state === 'CA') {
                        nocField.style.display = 'block';
                    } else {
                        nocField.style.display = 'none';
                    }
                });
            }

            // Dashboard Calculator Form Handler (with Authorization header and state-specific fields)
            document.getElementById('dashboardCalculatorForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const invoiceDate = document.getElementById('dashInvoiceDate').value;
                const state = document.getElementById('dashState').value.toUpperCase();
                
                if (!invoiceDate || !state) {
                    alert('Please enter both date and state');
                    return;
                }
                
                const submitButton = document.getElementById('dashCalcBtn');
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Calculating...';
                submitButton.disabled = true;
                
                try {
                    const token = getSessionToken();
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    if (token) {
                        headers['Authorization'] = 'Bearer ' + token;
                    }
                    
                    // Build request body with conditional fields
                    // API defaults: role="supplier", project_type="commercial"
                    const formData = {
                        invoice_date: invoiceDate,
                        state: state,
                        role: 'supplier', // Default
                        project_type: 'commercial' // Default
                    };
                    
                    // Override role for Washington (required)
                    if (state === 'WA') {
                        const role = document.getElementById('dashRole').value;
                        if (role) {
                            formData.role = role;
                        }
                    }
                    
                    // Override project type for Texas, Ohio (required)
                    if (state === 'TX' || state === 'OH') {
                        const projectType = document.getElementById('dashProjectType').value;
                        if (projectType) {
                            formData.project_type = projectType;
                        }
                    }
                    
                    // Add notice of completion date for California (optional)
                    if (state === 'CA') {
                        const nocDate = document.getElementById('dashNOCDate').value;
                        if (nocDate) {
                            formData.notice_of_completion_date = nocDate;
                        }
                    }
                    
                    const response = await fetch('/api/v1/calculate-deadline', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                        throw new Error(errorData.detail || errorData.error || `API returned ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Track GA4 event
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'calculator_submit', {
                            'event_category': 'Calculator',
                            'event_label': state,
                            'value': 1
                        });
                        
                        gtag('event', 'calculator_used', {
                            event_category: 'engagement',
                            event_label: 'lien_calculator'
                        });
                    }
                    
                    // Display results first
                    displayDashboardResults(data);
                    
                    // Then show save form after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        const stateCode = state;
                        const stateName = getStateNameFromCode(stateCode);
                        const prelimDays = data.preliminary_notice?.days_from_now || null;
                        const lienDays = data.lien_filing?.days_from_now || null;
                        
                        // Store and show save form
                        showSaveProjectForm({
                            stateName: stateName,
                            stateCode: stateCode,
                            invoiceDate: invoiceDate,
                            prelimDeadline: data.preliminary_notice?.deadline || null,
                            prelimDeadlineDays: prelimDays,
                            lienDeadline: data.lien_filing?.deadline || null,
                            lienDeadlineDays: lienDays
                        });
                    }, 300);
                    
                    // Save to history
                    saveCalculation(data);
                    
                    // Reload history table
                    loadHistory();
                    
                    // Scroll to results
                    document.getElementById('dashResults').scrollIntoView({ behavior: 'smooth' });
                    
                } catch (error) {
                    console.error('Calculation error:', error);
                    alert('Error calculating deadline: ' + error.message);
                } finally {
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                }
            });

            function displayDashboardResults(data) {
                // Calculate urgency based on days remaining
                function getUrgency(daysFromNow) {
                    if (daysFromNow === null || daysFromNow === undefined) return 'normal';
                    if (daysFromNow <= 7) return 'critical';
                    if (daysFromNow <= 30) return 'warning';
                    return 'normal';
                }
                
                // Get urgency from API response or calculate it
                const prelimUrgency = data.preliminary_notice.urgency || 
                    getUrgency(data.preliminary_notice.days_from_now);
                const lienUrgency = data.lien_filing.urgency || 
                    getUrgency(data.lien_filing.days_from_now);
                
                document.getElementById('dashResults').classList.remove('hidden');
                
                // Preliminary Notice (only show if required)
                if (data.preliminary_notice.required) {
                    const prelimCard = document.getElementById('dashPrelimCard');
                    prelimCard.className = `bg-white shadow-lg rounded-lg p-6 border-l-4 ${getUrgencyColor(prelimUrgency)}`;
                    document.getElementById('dashPrelimTitle').textContent = 
                        data.preliminary_notice.name || 'Preliminary Notice Deadline';
                    document.getElementById('dashPrelimDate').textContent = 
                        data.preliminary_notice.deadline ? formatDeadlineDate(data.preliminary_notice.deadline) : 'Not Required';
                    
                    const prelimDaysEl = document.getElementById('dashPrelimDays');
                    if (data.preliminary_notice.days_from_now !== null && data.preliminary_notice.days_from_now !== undefined) {
                        prelimDaysEl.textContent = `${data.preliminary_notice.days_from_now} days`;
                        prelimDaysEl.className = `text-2xl font-bold ${getUrgencyTextColor(prelimUrgency)}`;
                    } else {
                        prelimDaysEl.textContent = 'N/A';
                        prelimDaysEl.className = 'text-2xl font-bold text-gray-500';
                    }
                    prelimCard.style.display = 'block';
                } else {
                    // Hide preliminary notice card if not required
                    document.getElementById('dashPrelimCard').style.display = 'none';
                }
                
                // Lien Filing
                const lienCard = document.getElementById('dashLienCard');
                lienCard.className = `bg-white shadow-lg rounded-lg p-6 border-l-4 ${getUrgencyColor(lienUrgency)}`;
                document.getElementById('dashLienTitle').textContent = 
                    data.lien_filing.name || 'Lien Filing Deadline';
                    document.getElementById('dashLienDate').textContent = 
                        data.lien_filing.deadline ? formatDeadlineDate(data.lien_filing.deadline) : 'N/A';
                
                const lienDaysEl = document.getElementById('dashLienDays');
                if (data.lien_filing.days_from_now !== null && data.lien_filing.days_from_now !== undefined) {
                    lienDaysEl.textContent = `${data.lien_filing.days_from_now} days`;
                    lienDaysEl.className = `text-2xl font-bold ${getUrgencyTextColor(lienUrgency)}`;
                } else {
                    lienDaysEl.textContent = 'N/A';
                    lienDaysEl.className = 'text-2xl font-bold text-gray-500';
                }
                lienCard.style.display = 'block';
                
                // Show warnings if any
                if (data.warnings && data.warnings.length > 0) {
                    let warningsHtml = '<div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg mt-4"><h4 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Important Notes:</h4><ul class="list-disc list-inside text-yellow-700 space-y-1">';
                    data.warnings.forEach(warning => {
                        warningsHtml += `<li>${warning}</li>`;
                    });
                    warningsHtml += '</ul></div>';
                    
                    // Add warnings after results
                    const dashResults = document.getElementById('dashResults');
                    let warningsDiv = document.getElementById('dashWarnings');
                    if (!warningsDiv) {
                        warningsDiv = document.createElement('div');
                        warningsDiv.id = 'dashWarnings';
                        dashResults.appendChild(warningsDiv);
                    }
                    warningsDiv.innerHTML = warningsHtml;
                }
            }

            function saveCalculation(data) {
                // Get existing history
                let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
                
                // Add new calculation
                const calculation = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    invoice_date: data.invoice_date,
                    state: data.state_code || data.state,
                    state_name: data.state_name || data.state,
                    prelim_deadline: data.preliminary_notice?.deadline || null,
                    lien_deadline: data.lien_filing?.deadline || null,
                    prelim_days: data.preliminary_notice?.days_from_now || null,
                    lien_days: data.lien_filing?.days_from_now || null,
                    warnings: data.warnings || [],
                    data: data // Store full data for PDF generation
                };
                
                history.unshift(calculation); // Add to beginning
                
                // Keep only last 100 calculations
                if (history.length > 100) {
                    history = history.slice(0, 100);
                }
                
                localStorage.setItem('calculationHistory', JSON.stringify(history));
            }

            // Load calculation history from API
            async function loadCalculationHistory() {
                try {
                    const token = getSessionToken();
                    const headers = {};
                    if (token) {
                        headers['Authorization'] = 'Bearer ' + token;
                    }
                    
                    const response = await fetch('/api/calculations/history', {
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const tbody = document.getElementById('history-tbody');
                    
                    // Store globally so viewProject can access them
                    window.loadedCalculations = data.calculations || [];
                    
                    if (!data.success || !data.calculations || data.calculations.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8" style="text-align:center; padding:40px; color:#666;">
                                    No projects yet. Calculate a deadline above to get started!
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    tbody.innerHTML = data.calculations.map(calc => {
                        const amount = calc.invoiceAmount ? `$${calc.invoiceAmount.toLocaleString()}` : '-';
                        const prelimDate = calc.prelimDeadline ? formatDeadlineDate(calc.prelimDeadline) : 'Not Required';
                        const lienDate = formatDeadlineDate(calc.lienDeadline);
                        
                        return `
                            <tr style="border-bottom:1px solid #eee;">
                                <td style="padding:12px;">
                                    <strong>${escapeHtml(calc.projectName)}</strong>
                                    ${calc.notes ? `<br><small style="color:#666;">${escapeHtml(calc.notes).substring(0, 50)}...</small>` : ''}
                                </td>
                                <td style="padding:12px;">${escapeHtml(calc.clientName)}</td>
                                <td style="padding:12px; text-align:right;">${amount}</td>
                                <td style="padding:12px; text-align:center;">
                                    <span style="background:#e0e7ff; color:#3730a3; padding:4px 8px; border-radius:3px; font-size:12px;">
                                        ${calc.state}
                                    </span>
                                </td>
                                <td style="padding:12px; text-align:center;">${prelimDate}</td>
                                <td style="padding:12px; text-align:center;">${lienDate}</td>
                                <td style="padding:12px; text-align:center;">
                                    ${calc.activeReminders > 0 ? 
                                        `<span style="background:#dcfce7; color:#166534; padding:4px 8px; border-radius:3px; font-size:12px;">
                                            üìß ${calc.activeReminders} active
                                        </span>` : 
                                        `<span style="color:#999;">None</span>`
                                    }
                                </td>
                                <td style="padding:12px; text-align:center;">
                                    <button onclick="downloadProjectPDF('${calc.id}')" 
                                            style="background:#f97316; color:white; padding:6px 12px; border:none; border-radius:3px; cursor:pointer; margin-right:5px;">
                                        PDF
                                    </button>
                                    <button onclick="viewProject('${calc.id}')" 
                                            style="background:#3b82f6; color:white; padding:6px 12px; border:none; border-radius:3px; cursor:pointer;">
                                        View
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('Error loading calculation history:', error);
                    const tbody = document.getElementById('history-tbody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align:center; padding:40px; color:#dc2626;">
                                Error loading projects. Please refresh the page.
                            </td>
                        </tr>
                    `;
                }
            }

            function formatDeadlineDate(dateStr) {
                if (!dateStr) return 'N/A';
                
                const date = new Date(dateStr);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                date.setHours(0, 0, 0, 0);
                
                const daysUntil = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
                
                const formatted = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                
                let color = '#16a34a'; // green
                if (daysUntil < 0) color = '#dc2626'; // red - overdue
                else if (daysUntil < 7) color = '#ea580c'; // orange - urgent
                else if (daysUntil < 30) color = '#f59e0b'; // yellow - soon
                
                return `
                    <div>${formatted}</div>
                    <small style="color:${color}; font-weight:600;">
                        ${daysUntil < 0 ? 'OVERDUE' : `${daysUntil} days`}
                    </small>
                `;
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async function downloadProjectPDF(calculationId) {
                // TODO: Implement PDF download for specific project
                // For now, redirect to state guide PDF
                const token = getSessionToken();
                const headers = {};
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }
                
                try {
                    const response = await fetch(`/api/calculations/history`, {
                        headers: headers
                    });
                    const data = await response.json();
                    const calc = data.calculations?.find(c => c.id == calculationId);
                    
                    if (calc) {
                        const stateCode = calc.stateCode || calc.state;
                        const stateName = calc.state || getStateNameFromCode(stateCode);
                        const url = `/api/v1/guide/${stateCode}/pdf?invoice_date=${encodeURIComponent(calc.invoiceDate)}&state_name=${encodeURIComponent(stateName)}`;
                        window.open(url, '_blank');
                    } else {
                        alert('Unable to generate PDF. Project not found.');
                    }
                } catch (error) {
                    console.error('Error downloading PDF:', error);
                    alert('Error generating PDF. Please try again.');
                }
            }

                        // Global variable to store current project
            let currentProject = null;
            let loadedCalculations = [];

            function viewProject(calculationId) {
                // Convert to number in case it's passed as a string
                const id = parseInt(calculationId, 10);
                // Find the project from the loaded calculations
                const project = window.loadedCalculations?.find(c => c.id === id);
                
                if (!project) {
                    alert('Project not found');
                    return;
                }
                
                currentProject = project;
                
                // Format the project details
                const detailsHtml = `
                    <div style="display: grid; gap: 16px;">
                        <!-- Project Name -->
                        <div>
                            <label style="font-weight: bold; color: #4a5568; display: block; margin-bottom: 4px;">
                                Project Name
                            </label>
                            <div style="padding: 12px; background: #f7fafc; border-radius: 6px; color: #2d3748;">
                                ${escapeHtml(project.projectName || 'N/A')}
                            </div>
                        </div>
                        
                        <!-- Client Name -->
                        <div>
                            <label style="font-weight: bold; color: #4a5568; display: block; margin-bottom: 4px;">
                                Client/Customer
                            </label>
                            <div style="padding: 12px; background: #f7fafc; border-radius: 6px; color: #2d3748;">
                                ${escapeHtml(project.clientName || 'N/A')}
                            </div>
                        </div>
                        
                        <!-- Invoice Amount -->
                        <div>
                            <label style="font-weight: bold; color: #4a5568; display: block; margin-bottom: 4px;">
                                Invoice Amount
                            </label>
                            <div style="padding: 12px; background: #f7fafc; border-radius: 6px; color: #2d3748;">
                                $${parseFloat(project.invoiceAmount || 0).toLocaleString()}
                            </div>
                        </div>
                        
                        <!-- State -->
                        <div>
                            <label style="font-weight: bold; color: #4a5568; display: block; margin-bottom: 4px;">
                                State
                            </label>
                            <div style="padding: 12px; background: #f7fafc; border-radius: 6px; color: #2d3748;">
                                ${escapeHtml(project.state || 'N/A')} ${project.stateCode ? `(${project.stateCode})` : ''}
                            </div>
                        </div>
                        
                        <!-- Invoice Date -->
                        <div>
                            <label style="font-weight: bold; color: #4a5568; display: block; margin-bottom: 4px;">
                                Invoice/Delivery Date
                            </label>
                            <div style="padding: 12px; background: #f7fafc; border-radius: 6px; color: #2d3748;">
                                ${project.invoiceDate ? new Date(project.invoiceDate).toLocaleDateString() : 'N/A'}
                            </div>
                        </div>
                        
                        <!-- Preliminary Deadline -->
                        <div style="background: #c6f6d5; padding: 16px; border-radius: 8px; border: 2px solid #68d391;">
                            <label style="font-weight: bold; color: #276749; display: block; margin-bottom: 4px;">
                                üìã Preliminary Notice Deadline
                            </label>
                            <div style="font-size: 18px; color: #22543d; font-weight: bold;">
                                ${project.prelimDeadline ? new Date(project.prelimDeadline).toLocaleDateString() : 'Not Required'}
                            </div>
                            ${(project.prelimDeadline) && (project.prelimDeadlineDays) ? `
                                <div style="font-size: 14px; color: #276749; margin-top: 4px;">
                                    ${project.prelimDeadlineDays} days from invoice date
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Lien Deadline -->
                        <div style="background: #fef5e7; padding: 16px; border-radius: 8px; border: 2px solid #f6ad55;">
                            <label style="font-weight: bold; color: #7c2d12; display: block; margin-bottom: 4px;">
                                ‚öñÔ∏è Lien Filing Deadline
                            </label>
                            <div style="font-size: 18px; color: #7c2d12; font-weight: bold;">
                                ${project.lienDeadline ? new Date(project.lienDeadline).toLocaleDateString() : 'N/A'}
                            </div>
                            ${(project.lienDeadlineDays) ? `
                                <div style="font-size: 14px; color: #7c2d12; margin-top: 4px;">
                                    ${project.lienDeadlineDays} days from invoice date
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Notes -->
                        ${project.notes ? `
                            <div>
                                <label style="font-weight: bold; color: #4a5568; display: block; margin-bottom: 4px;">
                                    Notes
                                </label>
                                <div style="padding: 12px; background: #f7fafc; border-radius: 6px; color: #2d3748; white-space: pre-wrap;">
                                    ${escapeHtml(project.notes)}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- QuickBooks Invoice ID (if applicable) -->
                        ${project.quickbooksInvoiceId ? `
                            <div>
                                <label style="font-weight: bold; color: #4a5568; display: block; margin-bottom: 4px;">
                                    QuickBooks Invoice
                                </label>
                                <div style="padding: 12px; background: #ebf8ff; border-radius: 6px; color: #2c5282;">
                                    Invoice #${escapeHtml(project.quickbooksInvoiceId)}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Created Date -->
                        <div style="font-size: 12px; color: #718096; text-align: center; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                            Created: ${project.createdAt ? new Date(project.createdAt).toLocaleString() : 'N/A'}
                        </div>
                    </div>
                `;
                
                // Populate modal
                document.getElementById('project-details-content').innerHTML = detailsHtml;
                
                // Show modal
                const modal = document.getElementById('project-details-modal');
                modal.style.display = 'flex';
            }
            function closeProjectModal() {
                document.getElementById('project-details-modal').style.display = 'none';
                currentProject = null;
            }

            function downloadProjectPDF() {
                if (!currentProject) return;
                
                // Get invoice date
                const invoiceDate = currentProject.invoiceDate;
                if (!invoiceDate) {
                    alert('Invoice date not available for this project');
                    return;
                }
                
                // Format date as YYYY-MM-DD
                const dateStr = new Date(invoiceDate).toISOString().split('T')[0];
                const stateCode = currentProject.stateCode || 'UNKNOWN';
                const stateName = currentProject.state || '';
                
                // Generate PDF URL with invoice date
                // Get project type (default to commercial if not specified)
                const projectType = currentProject.projectType || 'commercial';
                
                // Build the PDF URL with all required parameters
                const pdfUrl = `/api/v1/guide/${stateCode}/pdf?invoice_date=${dateStr}&state_name=${encodeURIComponent(stateName)}&project_type=${projectType}`;
                
                // Open PDF in new tab
                window.open(pdfUrl, '_blank');
            }

            function editProject() {
                if (!currentProject) return;
                
                // Close modal
                closeProjectModal();
                
                // Pre-fill the calculator with project data
                const dateInput = document.getElementById('dashInvoiceDate');
                const stateSelect = document.getElementById('dashState');
                const projectTypeSelect = document.getElementById('dashProjectType');
                
                if (dateInput && currentProject.invoiceDate) {
                    // Format date as YYYY-MM-DD for date input
                    const dateStr = new Date(currentProject.invoiceDate).toISOString().split('T')[0];
                    dateInput.value = dateStr;
                }
                
                if (stateSelect && currentProject.stateCode) {
                    stateSelect.value = currentProject.stateCode;
                    // Trigger change event to show project type field if needed
                    stateSelect.dispatchEvent(new Event('change'));
                }
                
                if (projectTypeSelect && currentProject.projectType) {
                    projectTypeSelect.value = currentProject.projectType;
                } else if (projectTypeSelect) {
                    // Default to commercial if not specified
                    projectTypeSelect.value = 'commercial';
                }
                
                // Scroll to calculator section
                const calculatorSection = document.querySelector('.calculate-section') || document.getElementById('calculate-section') || document.querySelector('form#dashboardCalculatorForm');
                if (calculatorSection) {
                    calculatorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Optional: Show a message
                // Optional: Show a message
                setTimeout(() => {
                    alert(`Editing: ${currentProject.projectName}. Make your changes and click "Save Project & Set Reminders" to update.`);
                }, 500);
            }

            async function deleteProject() {
                if (!currentProject) return;
                
                const confirmed = confirm(`Are you sure you want to delete the project "${currentProject.projectName || 'this project'}"? This cannot be undone.`);
                
                if (!confirmed) return;
                
                try {
                    const token = getSessionToken();
                    const response = await fetch(`/api/calculations/${currentProject.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        alert('Project deleted successfully');
                        closeProjectModal();
                        loadCalculationHistory(); // Reload the projects table
                    } else {
                        const errorData = await response.json().catch(() => ({ detail: 'Failed to delete project' }));
                        alert(errorData.detail || 'Failed to delete project');
                    }
                } catch (error) {
                    console.error('Error deleting project:', error);
                    alert('Error deleting project');
                }
            }

            // Close modal when clicking outside
            document.addEventListener('DOMContentLoaded', function() {
                const modal = document.getElementById('project-details-modal');
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            closeProjectModal();
                        }
                    });
                }
            });


            // Legacy function for backward compatibility
            function loadHistory() {
                loadCalculationHistory();
            }

            function deleteCalculation(id) {
                if (!confirm('Delete this calculation?')) return;
                
                let history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
                history = history.filter(calc => calc.id !== id);
                localStorage.setItem('calculationHistory', JSON.stringify(history));
                loadHistory();
            }

            function downloadHistoryPDF(id) {
                const history = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
                const calc = history.find(c => c.id === id);
                
                if (!calc) {
                    alert('Unable to generate PDF. Please recalculate.');
                    return;
                }
                
                // Extract state code and name from calculation
                const stateCode = calc.state || calc.data?.state_code || calc.data?.state || 'UNKNOWN';
                const stateName = calc.state_name || (calc.data?.state_name || getStateNameFromCode(stateCode));
                
                // Use the SAME endpoint as homepage
                const url = `/api/v1/guide/${stateCode}/pdf?state_name=${encodeURIComponent(stateName)}`;
                
                // Open PDF in new tab
                window.open(url, '_blank');
                
                // Track GA4 event
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'pdf_download', {
                        'event_category': 'PDF',
                        'event_label': stateCode,
                        'value': 1
                    });
                }
            }

            // Export to CSV
            document.getElementById('exportCSV').addEventListener('click', async () => {
                try {
                    const token = getSessionToken();
                    const headers = {};
                    if (token) {
                        headers['Authorization'] = 'Bearer ' + token;
                    }
                    
                    const response = await fetch('/api/calculations/history', {
                        headers: headers
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success || !data.calculations || data.calculations.length === 0) {
                        alert('No projects to export');
                        return;
                    }
                    
                    // Create CSV content
                    const csvHeaders = ['Project Name', 'Client', 'Amount', 'State', 'Invoice Date', 'Prelim Deadline', 'Lien Deadline', 'Active Reminders'];
                    const rows = data.calculations.map(calc => [
                        calc.projectName || '',
                        calc.clientName || '',
                        calc.invoiceAmount ? `$${calc.invoiceAmount.toFixed(2)}` : '',
                        calc.state || '',
                        calc.invoiceDate || '',
                        calc.prelimDeadline || 'Not Required',
                        calc.lienDeadline || '',
                        calc.activeReminders || 0
                    ]);
                    
                    const csvContent = [
                        csvHeaders.join(','),
                        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                    ].join('\n');
                    
                    // Download CSV
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `lien-projects-${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Error exporting CSV:', error);
                    alert('Error exporting projects. Please try again.');
                }
            });

            // Utility functions
            function getUrgencyColor(urgency) {
                switch(urgency) {
                    case 'critical': return 'border-red-500';
                    case 'warning': return 'border-yellow-500';
                    default: return 'border-green-500';
                }
            }

            function getUrgencyTextColor(urgency) {
                switch(urgency) {
                    case 'critical': return 'text-red-600';
                    case 'warning': return 'text-yellow-600';
                    default: return 'text-green-600';
                }
            }

            function formatDeadlineDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }

            // Handle form submission
            document.getElementById('project-details-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!currentCalculation) {
                    showToast('‚ùå No calculation data found. Please calculate a deadline first.', 'error');
                    return;
                }
                
                const projectData = {
                    // Project details
                    projectName: document.getElementById('project-name').value.trim(),
                    clientName: document.getElementById('client-name').value.trim(),
                    invoiceAmount: document.getElementById('invoice-amount').value || null,
                    notes: document.getElementById('project-notes').value.trim() || null,
                    
                    // Calculation data
                    state: currentCalculation.stateName,
                    stateCode: currentCalculation.stateCode,
                    invoiceDate: currentCalculation.invoiceDate,
                    prelimDeadline: currentCalculation.prelimDeadline,
                    prelimDeadlineDays: currentCalculation.prelimDeadlineDays,
                    lienDeadline: currentCalculation.lienDeadline,
                    lienDeadlineDays: currentCalculation.lienDeadlineDays,
                    
                    // Reminder preferences
                    reminders: {
                        prelim7: document.getElementById('prelim-reminder-7').checked,
                        prelim1: document.getElementById('prelim-reminder-1').checked,
                        lien7: document.getElementById('lien-reminder-7').checked,
                        lien1: document.getElementById('lien-reminder-1').checked
                    }
                };
                
                // Validate required fields
                if (!projectData.projectName || !projectData.clientName) {
                    showToast('‚ùå Please fill in all required fields', 'error');
                    return;
                }
                
                // Show loading state
                const submitBtn = document.getElementById('save-project-btn');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Saving...';
                
                try {
                    const token = getSessionToken();
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    if (token) {
                        headers['Authorization'] = 'Bearer ' + token;
                    }
                    
                    const response = await fetch('/api/calculations/save', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(projectData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showToast(`‚úÖ Project saved with ${result.remindersCreated} email reminders!`, 'success');
                        
                        // Reset form
                        document.getElementById('project-details-form').reset();
                        document.getElementById('save-project-form').style.display = 'none';
                        
                        // Refresh calculation history
                        if (typeof loadCalculationHistory === 'function') {
                            loadCalculationHistory();
                        }
                        
                        // Reset current calculation
                        currentCalculation = null;
                    } else {
                        showToast('‚ùå Error: ' + (result.error || 'Failed to save project'), 'error');
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    showToast('‚ùå Network error. Please check your connection.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        </script>

        <!-- API Key Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Your API Key</h2>
            <div class="flex items-center gap-4">
                <input type="text" id="api-key" value="sk_live_1a2b3c4d5e6f7g8h" readonly class="flex-1 px-4 py-2 border border-gray-300 rounded-md bg-gray-50 font-mono">
                <button onclick="toggleApiKey()" id="toggle-key-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 font-semibold">Reveal</button>
                <button onclick="copyApiKey()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">Copy</button>
                <button onclick="regenerateApiKey()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 font-semibold">Regenerate</button>
            </div>
            <p class="text-sm text-gray-500 mt-2">Keep your API key secret. Never share it publicly.</p>
        </div>

        <!-- Usage Stats -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Usage This Month</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="text-sm text-gray-600 mb-2">Total API Calls</div>
                    <div class="text-3xl font-bold text-gray-900">1,247</div>
                    <div class="text-sm text-gray-500 mt-1">Last 30 days</div>
                </div>
                <div>
                    <div class="text-sm text-gray-600 mb-2">States Used</div>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">TX</span>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">CA</span>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">FL</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Billing Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Billing</h2>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="font-semibold">Current Plan</div>
                        <div class="text-sm text-gray-600">$299/month (Unlimited)</div>
                    </div>
                    <button onclick="openStripePortal()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">
                        Manage Billing
                    </button>
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-semibold">Payment Method</div>
                        <button onclick="updatePayment()" class="text-blue-600 hover:text-blue-700 text-sm">Update</button>
                    </div>
                    <div class="text-sm text-gray-600">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242</div>
                </div>
                <div class="border-t pt-4">
                    <div class="font-semibold mb-2">Next Charge</div>
                    <div class="text-sm text-gray-600">$299 on Dec 23, 2025</div>
                </div>
                <div class="border-t pt-4">
                    <button onclick="viewInvoices()" class="text-blue-600 hover:text-blue-700 text-sm font-semibold">View Invoices ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Partner Program Promotion -->
        <section class="partner-promotion" style="margin: 2rem 0; padding: 2rem; background: linear-gradient(135deg, #FFB085 0%, #FFD8C9 100%); border-radius: 12px; color: #2D3748;">
            <h2 style="margin-bottom: 1rem; font-size: 1.5rem;">ü§ù Become a Partner - Earn Commissions</h2>
            <p style="margin-bottom: 1.5rem; font-size: 1.1rem;">Earn up to $180K/year referring construction companies</p>
            
            <ul style="margin-bottom: 1.5rem; list-style: none; padding-left: 0;">
                <li style="margin-bottom: 0.5rem;">‚úì $500 per referral bounty</li>
                <li style="margin-bottom: 0.5rem;">‚úì $50/month recurring commission OR 15% revenue share</li>
                <li style="margin-bottom: 0.5rem;">‚úì Exclusive marketing materials and support</li>
            </ul>
            
                        <div style="margin: 24px 0; padding: 16px; background: rgba(255,176,133,0.15); border-radius: 8px;">
              <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Partner Revenue Scenarios (Choose One)</h4>
              
              <!-- Bounty Path -->
              <div style="margin-bottom: 12px;">
                <div style="font-size: 13px; font-weight: 600; color: #FF6B35;">Bounty Path (One-Time)</div>
                <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                  <tr>
                    <td>100 referrals √ó $500</td>
                    <td style="text-align: right; font-weight: 700;">$50K</td>
                  </tr>
                </table>
              </div>

              <!-- Recurring Path -->
              <div>
                <div style="font-size: 13px; font-weight: 600; color: #FF6B35;">Recurring Path (Monthly)</div>
                <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                  <tr>
                    <td>100 clients √ó $50/mo</td>
                    <td style="text-align: right;">$5K/mo</td>
                  </tr>
                  <tr style="border-top: 1px solid #FFE4D6;">
                    <td style="padding-top: 4px;">Annual</td>
                    <td style="text-align: right; font-weight: 700;">$60K/yr</td>
                  </tr>
                </table>
              </div>

              <div style="margin-top: 12px; font-size: 12px; color: #718096;">
                Choose bounty for immediate cash or recurring for long-term income.
              </div>
            </div>

<a href="https://liendeadline.com/partners.html" target="_blank" style="display: inline-block; padding: 12px 24px; background: #2D3748; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; transition: transform 0.2s;">
                Join Partner Program ‚Üí
            </a>
        </section>

        <!-- API Documentation Link -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-2">API Documentation</h2>
            <p class="text-gray-700 mb-4">Learn how to integrate our API into your application.</p>
            <a href="/test-api" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold">
                View API Docs ‚Üí
            </a>
        </div>
    </div>

    <script>
        let apiKeyVisible = false;
        let fullApiKey = ''; // Store full key

        // Initialize API key masking on page load
        window.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('api-key');
            if (input) {
                fullApiKey = input.value;
                maskApiKey();
            }
        });

        function maskApiKey() {
            const input = document.getElementById('api-key');
            const btn = document.getElementById('toggle-key-btn');
            
            if (fullApiKey) {
                // Show only prefix (first 12 chars) + ellipsis + last 4 chars
                const prefix = fullApiKey.substring(0, 12);
                const suffix = fullApiKey.substring(fullApiKey.length - 4);
                input.value = prefix + '‚Ä¶' + suffix;
                btn.textContent = 'Reveal';
                apiKeyVisible = false;
            }
        }

        function toggleApiKey() {
            const input = document.getElementById('api-key');
            const btn = document.getElementById('toggle-key-btn');
            
            if (apiKeyVisible) {
                maskApiKey();
            } else {
                input.value = fullApiKey;
                btn.textContent = 'Hide';
                apiKeyVisible = true;
            }
        }

        function copyApiKey() {
            // Always copy the full key, even if masked
            navigator.clipboard.writeText(fullApiKey).then(() => {
                alert('‚úÖ API key copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const input = document.getElementById('api-key');
                const originalValue = input.value;
                input.value = fullApiKey;
                input.select();
                document.execCommand('copy');
                input.value = originalValue;
                alert('‚úÖ API key copied to clipboard!');
            });
        }

        function scrollToCalculator(event) {
            event.preventDefault();
            const calculatorSection = document.getElementById('calculator');
            if (calculatorSection) {
                calculatorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function regenerateApiKey() {
            if (confirm('‚ö†Ô∏è Regenerating your API key will invalidate the current key. Continue?')) {
                // In production, call API to regenerate
                const newKey = 'sk_live_' + Math.random().toString(36).substr(2, 16);
                document.getElementById('api-key').value = newKey;
                alert('‚úÖ New API key generated!');
            }
        }

        async function openStripePortal() {
            // In production, call: POST /admin/portal
            try {
                const response = await fetch('/admin/portal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('customer_token')
                    },
                    body: JSON.stringify({
                        customer_id: localStorage.getItem('customer_id')
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    window.open(data.url, '_blank');
                } else {
                    throw new Error('Failed to create portal session');
                }
            } catch (error) {
                // Fallback for demo
                alert('Redirecting to Stripe billing portal...\n\nIn production, this opens: https://billing.stripe.com/p/session/...');
            }
        }

        function updatePayment() {
            alert('Opening payment method update...\n\nIn production, opens Stripe payment form.');
        }

        function viewInvoices() {
            alert('Opening invoices...\n\nIn production, shows list of invoices from Stripe.');
        }

        function logout() {
            if (confirm('Logout?')) {
                window.location.href = 'index.html';
            }
        }

        // QuickBooks Integration Functions
        async function connectQuickBooks() {
            const token = localStorage.getItem('session_token');
            if (!token) {
                alert('Please log in first');
                window.location.href = '/dashboard';
                return;
            }
            
            try {
                // Pass token as query parameter for browser redirect
                window.location.href = `/api/quickbooks/connect?token=${encodeURIComponent(token)}`;
            } catch (error) {
                console.error('Error connecting to QuickBooks:', error);
                alert('Failed to connect to QuickBooks. Please try again.');
            }
        }

        async function checkQuickBooksStatus() {
            const token = localStorage.getItem('session_token');
            if (!token) return;

            try {
                const response = await fetch('/api/quickbooks/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const statusEl = document.getElementById('qb-status');
                    const connectBtn = document.getElementById('qb-connect-btn');
                    
                    if (data.connected) {
                        if (statusEl) {
                            statusEl.textContent = 'Connected ‚úì';
                            statusEl.className = 'text-sm text-green-600 font-medium';
                        }
                        if (connectBtn) {
                            connectBtn.textContent = 'Disconnect';
                            connectBtn.onclick = disconnectQuickBooks;
                            connectBtn.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200';
                        }
                        loadQuickBooksInvoices();
                    } else {
                        if (statusEl) {
                            statusEl.textContent = 'Not connected';
                            statusEl.className = 'text-sm text-gray-600';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking QuickBooks status:', error);
            }
        }

        async function disconnectQuickBooks() {
            if (!confirm('Disconnect QuickBooks account?')) return;
            
            const token = localStorage.getItem('session_token');
            if (!token) return;

            try {
                const response = await fetch('/api/quickbooks/disconnect', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showNotification('QuickBooks disconnected successfully', 'success');
                    checkQuickBooksStatus();
                } else {
                    alert('Failed to disconnect QuickBooks account');
                }
            } catch (error) {
                console.error('Error disconnecting QuickBooks:', error);
                alert('Error disconnecting QuickBooks account');
            }
        }

        async function loadQuickBooksInvoices() {
            const token = localStorage.getItem('session_token');
            if (!token) return;

            try {
                const response = await fetch('/api/quickbooks/invoices', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Not connected
                        return;
                    }
                    throw new Error('Failed to load invoices');
                }
                
                const data = await response.json();
                displayQuickBooksInvoices(data.invoices || []);
            } catch (error) {
                console.error('Error loading QuickBooks invoices:', error);
            }
        }

        function displayQuickBooksInvoices(invoices) {
            const container = document.getElementById('qb-invoices');
            if (!container) return;
            
            if (!invoices || invoices.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            let html = '<h4 class="font-semibold text-lg mb-4 text-gray-900">üìä QuickBooks Invoices</h4>';
            html += '<p class="text-sm text-gray-600 mb-4">Select invoices to calculate lien deadlines</p>';
            html += '<div class="space-y-3 max-h-96 overflow-y-auto">';
            
            invoices.forEach(inv => {
                const date = inv.date || inv.invoice_number || 'N/A';
                const amount = inv.amount ? `$${inv.amount.toLocaleString()}` : '$0.00';
                const customer = escapeHtml(inv.customer_name || inv.customer || 'Unknown');
                const invoiceId = inv.id || inv.invoice_id || '';
                const invoiceNumber = inv.invoice_number || '';
                const balance = inv.balance || 0;
                const status = inv.status || (balance > 0 ? 'Unpaid' : 'Paid');
                
                html += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 hover:border-blue-300 transition">
                        <div class="flex justify-between items-center flex-wrap gap-4">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${date} - ${customer}</p>
                                <p class="text-sm text-gray-600">Amount: <span class="text-gray-900 font-semibold">${amount}</span></p>
                                ${invoiceNumber ? `<p class="text-xs text-gray-500">Invoice #${invoiceNumber}</p>` : ''}
                                <p class="text-xs ${status === 'Unpaid' ? 'text-red-600' : 'text-green-600'} font-medium mt-1">${status}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <select id="state-${invoiceId}" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select State...</option>
                                    ${getStateOptions()}
                                </select>
                                <button 
                                    onclick="calculateFromInvoice('${invoiceId}', '${date}', '${escapeHtml(customer)}', ${inv.amount || 0})"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap"
                                >
                                    Calculate
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function calculateForInvoice(invoiceDate, state) {
            // Auto-fill calculator with invoice data
            const dateInput = document.getElementById('dashInvoiceDate');
            const stateSelect = document.getElementById('dashState');
            
            if (dateInput && invoiceDate) {
                dateInput.value = invoiceDate;
            }
            
            if (stateSelect && state && state.length === 2) {
                stateSelect.value = state;
            }
            
            // Scroll to calculator section
            const calculatorSection = document.getElementById('calculator');
            if (calculatorSection) {
                calculatorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Highlight the form
            if (dateInput) {
                dateInput.focus();
                setTimeout(() => {
                    dateInput.blur();
                }, 1000);
            }
        }
        
        function getStateOptions() {
            const states = [
                { code: 'AL', name: 'Alabama' }, { code: 'AK', name: 'Alaska' }, { code: 'AZ', name: 'Arizona' },
                { code: 'AR', name: 'Arkansas' }, { code: 'CA', name: 'California' }, { code: 'CO', name: 'Colorado' },
                { code: 'CT', name: 'Connecticut' }, { code: 'DE', name: 'Delaware' }, { code: 'FL', name: 'Florida' },
                { code: 'GA', name: 'Georgia' }, { code: 'HI', name: 'Hawaii' }, { code: 'ID', name: 'Idaho' },
                { code: 'IL', name: 'Illinois' }, { code: 'IN', name: 'Indiana' }, { code: 'IA', name: 'Iowa' },
                { code: 'KS', name: 'Kansas' }, { code: 'KY', name: 'Kentucky' }, { code: 'LA', name: 'Louisiana' },
                { code: 'ME', name: 'Maine' }, { code: 'MD', name: 'Maryland' }, { code: 'MA', name: 'Massachusetts' },
                { code: 'MI', name: 'Michigan' }, { code: 'MN', name: 'Minnesota' }, { code: 'MS', name: 'Mississippi' },
                { code: 'MO', name: 'Missouri' }, { code: 'MT', name: 'Montana' }, { code: 'NE', name: 'Nebraska' },
                { code: 'NV', name: 'Nevada' }, { code: 'NH', name: 'New Hampshire' }, { code: 'NJ', name: 'New Jersey' },
                { code: 'NM', name: 'New Mexico' }, { code: 'NY', name: 'New York' }, { code: 'NC', name: 'North Carolina' },
                { code: 'ND', name: 'North Dakota' }, { code: 'OH', name: 'Ohio' }, { code: 'OK', name: 'Oklahoma' },
                { code: 'OR', name: 'Oregon' }, { code: 'PA', name: 'Pennsylvania' }, { code: 'RI', name: 'Rhode Island' },
                { code: 'SC', name: 'South Carolina' }, { code: 'SD', name: 'South Dakota' }, { code: 'TN', name: 'Tennessee' },
                { code: 'TX', name: 'Texas' }, { code: 'UT', name: 'Utah' }, { code: 'VT', name: 'Vermont' },
                { code: 'VA', name: 'Virginia' }, { code: 'WA', name: 'Washington' }, { code: 'WV', name: 'West Virginia' },
                { code: 'WI', name: 'Wisconsin' }, { code: 'WY', name: 'Wyoming' }, { code: 'DC', name: 'District of Columbia' }
            ];
            
            return states.map(s => `<option value="${s.code}">${s.code} - ${s.name}</option>`).join('');
        }
        
        function calculateFromInvoice(invoiceId, date, customer, amount) {
            const stateSelect = document.getElementById(`state-${invoiceId}`);
            const state = stateSelect ? stateSelect.value : '';
            
            if (!state) {
                alert('Please select a state first');
                return;
            }
            
            // Pre-fill calculator
            const dateInput = document.getElementById('dashInvoiceDate');
            const stateSelectMain = document.getElementById('dashState');
            
            if (dateInput && date) {
                dateInput.value = date;
            }
            
            if (stateSelectMain && state) {
                stateSelectMain.value = state;
            }
            
            // Scroll to calculator section
            const calculatorSection = document.getElementById('calculator') || document.querySelector('[id*="calculator"]') || document.querySelector('form#dashboardCalculatorForm');
            if (calculatorSection) {
                calculatorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Auto-calculate after a short delay
            setTimeout(() => {
                const calculateButton = document.querySelector('form#dashboardCalculatorForm button[type="submit"]');
                if (calculateButton) {
                    calculateButton.click();
                }
            }, 500);
        }
        
        function getStateOptions() {
            const states = [
                { code: 'AL', name: 'Alabama' }, { code: 'AK', name: 'Alaska' }, { code: 'AZ', name: 'Arizona' },
                { code: 'AR', name: 'Arkansas' }, { code: 'CA', name: 'California' }, { code: 'CO', name: 'Colorado' },
                { code: 'CT', name: 'Connecticut' }, { code: 'DE', name: 'Delaware' }, { code: 'FL', name: 'Florida' },
                { code: 'GA', name: 'Georgia' }, { code: 'HI', name: 'Hawaii' }, { code: 'ID', name: 'Idaho' },
                { code: 'IL', name: 'Illinois' }, { code: 'IN', name: 'Indiana' }, { code: 'IA', name: 'Iowa' },
                { code: 'KS', name: 'Kansas' }, { code: 'KY', name: 'Kentucky' }, { code: 'LA', name: 'Louisiana' },
                { code: 'ME', name: 'Maine' }, { code: 'MD', name: 'Maryland' }, { code: 'MA', name: 'Massachusetts' },
                { code: 'MI', name: 'Michigan' }, { code: 'MN', name: 'Minnesota' }, { code: 'MS', name: 'Mississippi' },
                { code: 'MO', name: 'Missouri' }, { code: 'MT', name: 'Montana' }, { code: 'NE', name: 'Nebraska' },
                { code: 'NV', name: 'Nevada' }, { code: 'NH', name: 'New Hampshire' }, { code: 'NJ', name: 'New Jersey' },
                { code: 'NM', name: 'New Mexico' }, { code: 'NY', name: 'New York' }, { code: 'NC', name: 'North Carolina' },
                { code: 'ND', name: 'North Dakota' }, { code: 'OH', name: 'Ohio' }, { code: 'OK', name: 'Oklahoma' },
                { code: 'OR', name: 'Oregon' }, { code: 'PA', name: 'Pennsylvania' }, { code: 'RI', name: 'Rhode Island' },
                { code: 'SC', name: 'South Carolina' }, { code: 'SD', name: 'South Dakota' }, { code: 'TN', name: 'Tennessee' },
                { code: 'TX', name: 'Texas' }, { code: 'UT', name: 'Utah' }, { code: 'VT', name: 'Vermont' },
                { code: 'VA', name: 'Virginia' }, { code: 'WA', name: 'Washington' }, { code: 'WV', name: 'West Virginia' },
                { code: 'WI', name: 'Wisconsin' }, { code: 'WY', name: 'Wyoming' }, { code: 'DC', name: 'District of Columbia' }
            ];
            
            return states.map(s => `<option value="${s.code}">${s.code} - ${s.name}</option>`).join('');
        }
        
        function calculateFromInvoice(invoiceId, date, customer, amount) {
            const stateSelect = document.getElementById(`state-${invoiceId}`);
            const state = stateSelect ? stateSelect.value : '';
            
            if (!state) {
                alert('Please select a state first');
                return;
            }
            
            // Pre-fill calculator
            const dateInput = document.getElementById('dashInvoiceDate');
            const stateSelectMain = document.getElementById('dashState');
            
            if (dateInput && date) {
                dateInput.value = date;
            }
            
            if (stateSelectMain && state) {
                stateSelectMain.value = state;
            }
            
            // Scroll to calculator section
            const calculatorSection = document.getElementById('calculator') || document.querySelector('[id*="calculator"]') || document.querySelector('form#dashboardCalculatorForm');
            if (calculatorSection) {
                calculatorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Auto-calculate after a short delay
            setTimeout(() => {
                const calculateButton = document.querySelector('form#dashboardCalculatorForm button[type="submit"]');
                if (calculateButton) {
                    calculateButton.click();
                }
            }, 500);
        }
        
        function getStateOptions() {
            const states = [
                { code: 'AL', name: 'Alabama' }, { code: 'AK', name: 'Alaska' }, { code: 'AZ', name: 'Arizona' },
                { code: 'AR', name: 'Arkansas' }, { code: 'CA', name: 'California' }, { code: 'CO', name: 'Colorado' },
                { code: 'CT', name: 'Connecticut' }, { code: 'DE', name: 'Delaware' }, { code: 'FL', name: 'Florida' },
                { code: 'GA', name: 'Georgia' }, { code: 'HI', name: 'Hawaii' }, { code: 'ID', name: 'Idaho' },
                { code: 'IL', name: 'Illinois' }, { code: 'IN', name: 'Indiana' }, { code: 'IA', name: 'Iowa' },
                { code: 'KS', name: 'Kansas' }, { code: 'KY', name: 'Kentucky' }, { code: 'LA', name: 'Louisiana' },
                { code: 'ME', name: 'Maine' }, { code: 'MD', name: 'Maryland' }, { code: 'MA', name: 'Massachusetts' },
                { code: 'MI', name: 'Michigan' }, { code: 'MN', name: 'Minnesota' }, { code: 'MS', name: 'Mississippi' },
                { code: 'MO', name: 'Missouri' }, { code: 'MT', name: 'Montana' }, { code: 'NE', name: 'Nebraska' },
                { code: 'NV', name: 'Nevada' }, { code: 'NH', name: 'New Hampshire' }, { code: 'NJ', name: 'New Jersey' },
                { code: 'NM', name: 'New Mexico' }, { code: 'NY', name: 'New York' }, { code: 'NC', name: 'North Carolina' },
                { code: 'ND', name: 'North Dakota' }, { code: 'OH', name: 'Ohio' }, { code: 'OK', name: 'Oklahoma' },
                { code: 'OR', name: 'Oregon' }, { code: 'PA', name: 'Pennsylvania' }, { code: 'RI', name: 'Rhode Island' },
                { code: 'SC', name: 'South Carolina' }, { code: 'SD', name: 'South Dakota' }, { code: 'TN', name: 'Tennessee' },
                { code: 'TX', name: 'Texas' }, { code: 'UT', name: 'Utah' }, { code: 'VT', name: 'Vermont' },
                { code: 'VA', name: 'Virginia' }, { code: 'WA', name: 'Washington' }, { code: 'WV', name: 'West Virginia' },
                { code: 'WI', name: 'Wisconsin' }, { code: 'WY', name: 'Wyoming' }, { code: 'DC', name: 'District of Columbia' }
            ];
            
            return states.map(s => `<option value="${s.code}">${s.code} - ${s.name}</option>`).join('');
        }
        
        function calculateFromInvoice(invoiceId, date, customer, amount) {
            const stateSelect = document.getElementById(`state-${invoiceId}`);
            const state = stateSelect ? stateSelect.value : '';
            
            if (!state) {
                alert('Please select a state first');
                return;
            }
            
            // Pre-fill calculator
            const dateInput = document.getElementById('dashInvoiceDate');
            const stateSelectMain = document.getElementById('dashState');
            
            if (dateInput && date) {
                dateInput.value = date;
            }
            
            if (stateSelectMain && state) {
                stateSelectMain.value = state;
            }
            
            // Scroll to calculator section
            const calculatorSection = document.getElementById('calculator') || document.querySelector('[id*="calculator"]') || document.querySelector('form#dashboardCalculatorForm');
            if (calculatorSection) {
                calculatorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Auto-calculate after a short delay
            setTimeout(() => {
                const calculateButton = document.querySelector('form#dashboardCalculatorForm button[type="submit"]');
                if (calculateButton) {
                    calculateButton.click();
                }
            }, 500);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            // Simple notification function
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white ${
                type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            } shadow-lg z-50 transition-all`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Sage Integration Functions
        async function connectSage() {
            const token = localStorage.getItem('session_token');
            if (!token) {
                alert('Please log in first');
                window.location.href = '/dashboard';
                return;
            }
            
            try {
                // Pass token as query parameter for browser redirect
                window.location.href = `/api/sage/auth?token=${encodeURIComponent(token)}`;
            } catch (error) {
                console.error('Error connecting to Sage:', error);
                alert('Failed to connect to Sage. Please try again.');
            }
        }

        // Procore Integration Functions
        async function connectProcore() {
            const token = localStorage.getItem('session_token');
            if (!token) {
                alert('Please log in first');
                window.location.href = '/dashboard';
                return;
            }
            
            try {
                // Pass token as query parameter for browser redirect
                window.location.href = `/api/procore/auth?token=${encodeURIComponent(token)}`;
            } catch (error) {
                console.error('Error connecting to Procore:', error);
                alert('Failed to connect to Procore. Please try again.');
            }
        }

        async function checkProcoreStatus() {
            const token = localStorage.getItem('session_token');
            if (!token) return;

            try {
                const response = await fetch('/api/procore/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const statusEl = document.getElementById('procore-status');
                    const connectBtn = document.getElementById('procore-connect-btn');
                    
                    if (data.connected) {
                        if (statusEl) {
                            statusEl.textContent = 'Connected ‚úì';
                            statusEl.className = 'text-sm text-green-600 font-medium';
                        }
                        if (connectBtn) {
                            connectBtn.textContent = 'Disconnect';
                            connectBtn.onclick = disconnectProcore;
                            connectBtn.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200';
                        }
                        loadProcoreProjects();
                    } else {
                        if (statusEl) {
                            statusEl.textContent = 'Not connected';
                            statusEl.className = 'text-sm text-gray-600';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking Procore status:', error);
            }
        }

        async function loadProcoreProjects() {
            const token = localStorage.getItem('session_token');
            if (!token) return;

            try {
                const response = await fetch('/api/procore/projects', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Not connected
                        return;
                    }
                    throw new Error('Failed to load projects');
                }
                
                const data = await response.json();
                displayProcoreProjects(data.projects || []);
            } catch (error) {
                console.error('Error loading Procore projects:', error);
            }
        }

        function displayProcoreProjects(projects) {
            const container = document.getElementById('procore-projects');
            if (!container) return;
            
            if (!projects || projects.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            let html = '<h4 class="font-semibold text-lg mb-4 text-gray-900">Projects from Procore</h4>';
            html += '<div class="space-y-3 max-h-96 overflow-y-auto">';
            
            projects.forEach(project => {
                const name = escapeHtml(project.name || 'Unnamed Project');
                const id = project.id || '';
                const address = project.address ? escapeHtml(project.address) : '';
                
                html += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 hover:border-purple-300 transition">
                        <div class="flex justify-between items-center flex-wrap gap-4">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${name}</p>
                                ${address ? `<p class="text-sm text-gray-600 mt-1">${address}</p>` : ''}
                                ${id ? `<p class="text-xs text-gray-500 mt-1">Project ID: ${id}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        async function disconnectProcore() {
            if (!confirm('Disconnect Procore account?')) return;
            
            const token = localStorage.getItem('session_token');
            if (!token) return;

            try {
                const response = await fetch('/api/procore/disconnect', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    showNotification('Procore disconnected successfully', 'success');
                    checkProcoreStatus();
                } else {
                    alert('Failed to disconnect Procore account');
                }
            } catch (error) {
                console.error('Error disconnecting Procore:', error);
                alert('Error disconnecting Procore account');
            }
        }

        // Report Integration Issue
        function reportIntegrationIssue(integrationName) {
            // Get user email if available
            const userEmail = localStorage.getItem('user_email') || 'user@example.com';
            
            // Create mailto link with pre-filled subject and body
            const subject = encodeURIComponent(`Integration Issue - ${integrationName}`);
            const body = encodeURIComponent(
                `Integration: ${integrationName}\n\n` +
                `Issue Description:\n` +
                `[Please describe the issue you're experiencing]\n\n` +
                `Steps to Reproduce:\n` +
                `1. \n` +
                `2. \n` +
                `3. \n\n` +
                `Expected Behavior:\n` +
                `[What should happen]\n\n` +
                `Actual Behavior:\n` +
                `[What actually happens]\n\n` +
                `Additional Details:\n` +
                `[Any other relevant information]`
            );
            
            const mailtoLink = `mailto:support@liendeadline.com?subject=${subject}&body=${body}`;
            window.location.href = mailtoLink;
        }

        async function checkSageStatus() {
            const token = localStorage.getItem('session_token');
            if (!token) return;

            try {
                const response = await fetch('/api/sage/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const statusEl = document.getElementById('sage-status');
                    const connectBtn = document.getElementById('sage-connect-btn');
                    
                    if (data.connected) {
                        if (statusEl) {
                            statusEl.textContent = 'Connected ‚úì';
                            statusEl.className = 'text-sm text-green-600 font-medium';
                        }
                        if (connectBtn) {
                            connectBtn.textContent = 'Reconnect';
                        }
                        loadSageInvoices();
                    } else {
                        if (statusEl) {
                            statusEl.textContent = 'Not connected';
                            statusEl.className = 'text-sm text-gray-600';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking Sage status:', error);
            }
        }

        async function loadSageInvoices() {
            const token = localStorage.getItem('session_token');
            if (!token) return;

            try {
                const response = await fetch('/api/sage/invoices', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Not connected
                        return;
                    }
                    throw new Error('Failed to load invoices');
                }
                
                const data = await response.json();
                displaySageInvoices(data.invoices || []);
            } catch (error) {
                console.error('Error loading Sage invoices:', error);
            }
        }

        function displaySageInvoices(invoices) {
            const container = document.getElementById('sage-invoices');
            if (!container) return;
            
            if (!invoices || invoices.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            let html = '<h4 class="font-semibold text-lg mb-4 text-gray-900">Recent Invoices from Sage</h4>';
            html += '<div class="space-y-3 max-h-96 overflow-y-auto">';
            
            invoices.forEach(inv => {
                const date = inv.date || 'N/A';
                const amount = inv.amount ? `$${inv.amount.toFixed(2)}` : '$0.00';
                const state = inv.state || '';
                const customer = escapeHtml(inv.customer || 'Unknown');
                
                html += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 hover:border-green-300 transition">
                        <div class="flex justify-between items-center flex-wrap gap-4">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">${customer}</p>
                                <p class="text-sm text-gray-600">Date: ${date} | Amount: ${amount}</p>
                                ${state ? `<p class="text-xs text-gray-500 mt-1">State: ${state}</p>` : ''}
                            </div>
                            <button 
                                onclick="calculateForInvoice('${date}', '${state}')"
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition whitespace-nowrap"
                            >
                                Calculate Deadline
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Check if just connected from OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('qb_connected') === 'true') {
            setTimeout(() => {
                showNotification('QuickBooks connected successfully!', 'success');
                checkQuickBooksStatus();
            }, 500);
        }
        if (urlParams.get('sage_connected') === 'true') {
            setTimeout(() => {
                showNotification('Sage connected successfully!', 'success');
                checkSageStatus();
            }, 500);
        }
        if (urlParams.get('procore_connected') === 'true') {
            setTimeout(() => {
                showNotification('Procore connected successfully!', 'success');
                checkProcoreStatus();
            }, 500);
        }

        // Check integration statuses on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkQuickBooksStatus();
            checkSageStatus();
            checkProcoreStatus();
        });
    </script>

    <!-- Project Details Modal -->
    <div id="project-details-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 24px; position: relative;">
            <!-- Close Button -->
            <button onclick="closeProjectModal()" style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: #718096;">
                √ó
            </button>
            
            <!-- Modal Header -->
            <h2 style="margin-top: 0; color: #2d3748;">Project Details</h2>
            
            <!-- Project Info -->
            <div id="project-details-content">
                <!-- Will be populated by JavaScript -->
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; margin-top: 24px; border-top: 1px solid #e2e8f0; padding-top: 24px;">
                <button onclick="downloadProjectPDF()" style="background: #f97316; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; flex: 1;">
                    üìÑ Download PDF
                </button>
                <button onclick="editProject()" style="background: #3182ce; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; flex: 1;">
                    ‚úèÔ∏è Edit Project
                </button>
                <button onclick="deleteProject()" style="background: #e53e3e; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; flex: 1;">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
    </div>

</body>
</html>

